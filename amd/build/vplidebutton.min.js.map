{"version":3,"file":"vplidebutton.min.js","sources":["../src/vplidebutton.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * IDE Buttons\n *\n * @copyright 2016 Juan Carlos Rodríguez-del-Pino\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>\n */\n\ndefine(\n    [\n        'jquery',\n        'jqueryui',\n        'mod_vpl/vplutil',\n    ],\n    function($, jqui, VPLUtil) {\n        if (typeof VPLIDEButtons !== 'undefined') {\n            return VPLIDEButtons;\n        }\n        var VPLIDEButtons = function(menuElement, isOptionAllowed) {\n            var self = this;\n            var buttons = {};\n\n            this.notAdded = function(buttonName) {\n                return !buttons[buttonName];\n            };\n            this.setText = function(buttonName, icon, title) {\n                if (self.notAdded(buttonName)) {\n                    return;\n                }\n                if (!icon) {\n                    icon = buttons[buttonName].icon;\n                }\n                if (!title) {\n                    title = buttons[buttonName].title;\n                }\n                if (!title) {\n                    title = VPLUtil.str(icon);\n                }\n                buttons[buttonName].icon = icon;\n                buttons[buttonName].title = title;\n                if (buttons[buttonName].hasOwnProperty('key')) {\n                    title += ' (' + buttons[buttonName].key + ')';\n                }\n                $('#vpl_ide_' + buttonName).attr('title', title);\n                $('#vpl_ide_' + buttonName + ' i').replaceWith(VPLUtil.genIcon(icon));\n            };\n            this.setExtracontent = function(buttonName, html) {\n                if (self.notAdded(buttonName)) {\n                    return;\n                }\n                var cl = 'bt_extrahtml';\n                var btag = $('#vpl_ide_' + buttonName + ' i');\n                if (btag.find('.' + cl).length == 0) {\n                    btag.append(' <span class=\"' + cl + '\"><span>');\n                }\n                btag.find('.' + cl).html(html);\n            };\n            this.add = function(button) {\n                if (typeof button === 'string') {\n                    var name = button;\n                    button = {\n                        'name': name\n                    };\n                }\n                if (!isOptionAllowed(button.name)) {\n                    return;\n                }\n                if (!button.hasOwnProperty('icon')) {\n                    button.icon = button.name;\n                }\n                if (!button.hasOwnProperty('title')) {\n                    button.title = VPLUtil.str(button.name);\n                }\n                if (!button.hasOwnProperty('active')) {\n                    button.active = true;\n                }\n                if (!button.hasOwnProperty('editorName')) {\n                    button.editorName = button.name;\n                }\n                if (!button.hasOwnProperty('originalAction')) {\n                    button.originalAction = VPLUtil.doNothing;\n                }\n                if (self.notAdded(button.name)) {\n                    buttons[button.name] = button;\n                } else {\n                    throw new Error(\"Button already set \" + button.name);\n                }\n                self.setAction(button.name, button.originalAction);\n                if (button.hasOwnProperty('bindKey')) {\n                    button.command = {\n                        name: button.editorName,\n                        bindKey: button.bindKey,\n                        exec: button.action\n                    };\n                    var platform = \"win\";\n                    if (navigator.platform.startsWith(\"Mac\")) {\n                        platform = \"mac\";\n                    }\n                    button.key = button.bindKey[platform];\n                }\n            };\n            this.getHTML = function(buttonName) {\n                if (self.notAdded(buttonName)) {\n                    return '';\n                } else {\n                    var title = buttons[buttonName].title;\n                    if (buttons[buttonName].hasOwnProperty('key')) {\n                        title += ' (' + buttons[buttonName].key + ')';\n                    }\n\n                    var html = \"<a id='vpl_ide_\" + buttonName + \"' href='#' title='\" + title + \"'>\";\n                    html += VPLUtil.genIcon(buttons[buttonName].icon) + \"</a>\";\n                    return html;\n                }\n            };\n\n            this.enable = function(buttonName, active) {\n                if (self.notAdded(buttonName)) {\n                    return;\n                }\n                var bw = $('#vpl_ide_' + buttonName);\n                buttons[buttonName].active = active;\n                bw.data(\"vpl-active\", active);\n                if (!active) {\n                    bw.addClass('ui-button-disabled ui-state-disabled');\n                } else {\n                    bw.removeClass('ui-button-disabled ui-state-disabled');\n                }\n            };\n            this.setAction = function(buttonName, action) {\n                if (self.notAdded(buttonName)) {\n                    return;\n                }\n                buttons[buttonName].originalAction = action;\n                buttons[buttonName].action = function() {\n                    if (buttons[buttonName].active) {\n                        action();\n                    }\n                };\n            };\n            this.getAction = function(buttonName) {\n                if (self.notAdded(buttonName)) {\n                    return VPLUtil.doNothing;\n                }\n                return buttons[buttonName].action;\n            };\n            this.launchAction = function(buttonName) {\n                if (self.notAdded(buttonName)) {\n                    return;\n                }\n                buttons[buttonName].originalAction();\n            };\n            this.setGetkeys = function(editor) {\n                if (!editor) {\n                    return;\n                }\n                var commands = editor.commands.commands;\n                var platform = editor.commands.platform;\n                for (var buttonName in buttons) {\n                    if (buttons.hasOwnProperty(buttonName)) {\n                        var editorName = buttons[buttonName].editorName;\n                        if (commands[editorName] && commands[editorName].bindKey && !buttons[buttonName].Key) {\n                            buttons[buttonName].key = commands[editorName].bindKey[platform];\n                            self.setText(buttonName);\n                        } else {\n                            if (buttons[buttonName].bindKey &&\n                                !buttons[buttonName].hasOwnProperty('key')) {\n                                buttons[buttonName].key = buttons[buttonName].bindKey[platform];\n                                self.setText(buttonName);\n                            }\n                        }\n                    }\n                }\n            };\n            this.getShortcuts = function(editor) {\n                var html = '<ul>';\n                for (var buttonName in buttons) {\n                    if (buttons[buttonName].hasOwnProperty('key')) {\n                        html += '<li>';\n                        html += buttons[buttonName].title + ' (' + buttons[buttonName].key + ')';\n                        html += '</li>';\n                    }\n                }\n                html += '</ul>';\n                if (editor) {\n                    html += '<h5>' + VPLUtil.str('edit') + '</h5>';\n                    var commands = editor.commands.commands;\n                    var platform = editor.commands.platform;\n                    html += '<ul>';\n                    for (var editorName in commands) {\n                        if (commands[editorName].hasOwnProperty('bindKey') && commands[editorName].bindKey[platform] > '') {\n                            html += '<li>';\n                            html += editorName + ' (' + commands[editorName].bindKey[platform] + ')';\n                            html += '</li>';\n                        }\n                    }\n                    html += '</ul>';\n                }\n                if (html == '<ul></ul>') {\n                    return '';\n                }\n                return html;\n            };\n            $(menuElement).on(\"click\", \"a\", function(event) {\n                if ($(this).data(\"vpl-active\")) {\n                    var actionid = $(this).attr('id');\n                    if (typeof actionid === 'string' && actionid.startsWith('vpl_ide_')) {\n                        actionid = actionid.replace('vpl_ide_', '');\n                    } else {\n                        return true;\n                    }\n                    if (self.notAdded(actionid)) {\n                        return true;\n                    }\n                    if (buttons[actionid] && !buttons[actionid].active) {\n                        return true;\n                    }\n                    var action = self.getAction(actionid);\n                    if (actionid != 'import') {\n                        setTimeout(action, 10);\n                    } else {\n                        action();\n                    }\n                }\n                event.stopImmediatePropagation();\n                return false;\n            });\n\n            $('body').on('keydown', function(event) {\n                var check = false;\n                var strkey = '';\n                if (event.shiftKey) {\n                    strkey += 'shift-';\n                }\n                if (event.altKey) {\n                    strkey += 'alt-';\n                    check = true;\n                }\n                if (event.ctrlKey) {\n                    strkey += 'ctrl-';\n                    check = true;\n                }\n                if (event.metaKey) {\n                    strkey += 'meta-';\n                    check = true;\n                }\n                if (event.which >= 112 && event.which <= 123) {\n                    strkey += 'f' + (event.which - 111);\n                    check = true;\n                } else {\n                    var char = String.fromCharCode(event.which).toLowerCase();\n                    if (char < 'a' || char > 'z') {\n                        check = false;\n                    } else {\n                        strkey += char;\n                    }\n                }\n                if (check) {\n                    for (var buttonName in buttons) {\n                        if (buttons[buttonName].hasOwnProperty('key')) {\n                            if (strkey == buttons[buttonName].key.toLowerCase()) {\n                                event.preventDefault();\n                                event.stopImmediatePropagation();\n                                buttons[buttonName].action();\n                                return false;\n                            }\n                        }\n                    }\n                }\n                return true;\n            });\n            this.multiple = function(v, m) {\n                return v - (v % m);\n            };\n\n            (function() {\n                var start = 0;\n                var lastLap = 0;\n                var interval = false;\n                var hour = 60 * 60;\n                var day = hour * 24;\n                var cssclasses = 'vpl_buttonleft_orange vpl_buttonleft_red vpl_buttonleft_black';\n                var show = false;\n                var element = null;\n                var precision = 5;\n                var checkt = 1000;\n                var timeLeft = 0;\n                var updatePrecision = function(timeLeft) {\n                    precision = 5;\n                    checkt = 1000;\n                    if (timeLeft > hour) {\n                        precision = 60;\n                        checkt = 5000;\n                    } else if (timeLeft > day) {\n                        precision = 5 * 60;\n                        checkt = 5 * 5000;\n                    }\n                };\n                var updateTimeLeft = function() {\n                    var now = self.multiple(VPLUtil.getCurrentTime(), precision);\n                    if (now === lastLap || element === null) {\n                        return;\n                    }\n                    lastLap = now;\n                    var tl = timeLeft - (lastLap - start);\n                    var cssclass = '';\n                    if (tl <= 0) {\n                        cssclass = 'vpl_buttonleft_black';\n                    } else if (tl <= 5 * 60) {\n                        show = true;\n                        cssclass = 'vpl_buttonleft_red';\n                    } else if (tl <= 15 * 60) {\n                        cssclass = 'vpl_buttonleft_orange';\n                    } else {\n                        updatePrecision(tl);\n                    }\n                    var thtml = '<span class=\"' + cssclass + '\">' + VPLUtil.genIcon('timeleft');\n                    if (show) {\n                        thtml += ' ' + VPLUtil.getTimeLeft(tl);\n                    }\n                    thtml += '</span>';\n                    element.html(thtml);\n                    element.removeClass(cssclasses);\n                    element.addClass(cssclass);\n                };\n                self.toggleTimeLeft = function() {\n                    show = !show;\n                    lastLap = 0;\n                    updateTimeLeft();\n                };\n                self.setTimeLeft = function(options) {\n                    element = $('#vpl_ide_timeleft');\n                    if (interval !== false) {\n                        clearInterval(interval);\n                        interval = false;\n                    }\n                    if (options.hasOwnProperty('timeLeft')) {\n                        timeLeft = options.timeLeft;\n                        updatePrecision(timeLeft);\n                        var sync = timeLeft % precision;\n                        timeLeft = self.multiple(timeLeft, precision);\n                        start = self.multiple(VPLUtil.getCurrentTime(), precision);\n                        lastLap = start - precision;\n                        setTimeout(function() {\n                            interval = setInterval(updateTimeLeft, checkt);\n                        }, sync * 1000);\n                        $('#vpl_ide_timeleft').show();\n                        updateTimeLeft();\n\n                    } else {\n                        $('#vpl_ide_timeleft').hide();\n                    }\n                };\n            })();\n        };\n        window.VPLIDEButtons = VPLIDEButtons;\n        return VPLIDEButtons;\n    }\n);\n"],"names":["define","$","jqui","VPLUtil","VPLIDEButtons","menuElement","isOptionAllowed","start","lastLap","interval","show","element","precision","checkt","timeLeft","updatePrecision","updateTimeLeft","self","this","buttons","notAdded","buttonName","setText","icon","title","str","hasOwnProperty","key","attr","replaceWith","genIcon","setExtracontent","html","cl","btag","find","length","append","add","button","name","active","editorName","originalAction","doNothing","Error","setAction","command","bindKey","exec","action","platform","navigator","startsWith","getHTML","enable","bw","data","removeClass","addClass","getAction","launchAction","setGetkeys","editor","commands","Key","getShortcuts","on","event","actionid","replace","setTimeout","stopImmediatePropagation","check","strkey","shiftKey","altKey","ctrlKey","metaKey","which","char","String","fromCharCode","toLowerCase","preventDefault","multiple","v","m","hour","now","getCurrentTime","tl","cssclass","thtml","getTimeLeft","toggleTimeLeft","setTimeLeft","options","clearInterval","sync","setInterval","hide","window"],"mappings":"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"}