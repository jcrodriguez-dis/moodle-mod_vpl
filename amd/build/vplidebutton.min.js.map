{"version":3,"file":"vplidebutton.min.js","sources":["../src/vplidebutton.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * IDE Buttons\n *\n * @copyright 2016 Juan Carlos Rodríguez-del-Pino\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>\n */\n\nimport $ from 'jquery';\n/* eslint-disable no-unused-vars */\nimport jqui from 'jqueryui';\n/* eslint-enable no-unused-vars */\nimport {VPLUtil} from 'mod_vpl/vplutil';\nimport {VPLUI} from 'mod_vpl/vplui';\n\nexport class VPLIDEButtons {\n    constructor(menuElement, isOptionAllowed) {\n        var self = this;\n        var buttons = {};\n\n        this.notAdded = function(buttonName) {\n            return !buttons[buttonName];\n        };\n        this.setText = function(buttonName, icon, title) {\n            if (self.notAdded(buttonName)) {\n                return;\n            }\n            if (!icon) {\n                icon = buttons[buttonName].icon;\n            }\n            if (!title) {\n                title = buttons[buttonName].title;\n            }\n            if (!title) {\n                title = VPLUtil.str(icon);\n            }\n            buttons[buttonName].icon = icon;\n            buttons[buttonName].title = title;\n            if (buttons[buttonName].hasOwnProperty('key')) {\n                title += ' (' + buttons[buttonName].key + ')';\n            }\n            $('#vpl_ide_' + buttonName).attr('title', title);\n            $('#vpl_ide_' + buttonName + ' i').replaceWith(VPLUI.genIcon(icon));\n        };\n        this.setExtracontent = function(buttonName, html) {\n            if (self.notAdded(buttonName)) {\n                return;\n            }\n            var cl = 'vpl_bt_extrahtml';\n            var btag = $('#vpl_ide_' + buttonName);\n            if (btag.find('.' + cl).length == 0) {\n                btag.append(' <span class=\"' + cl + '\"><span>');\n            }\n            btag.find('.' + cl).html(html);\n        };\n        this.add = function(button) {\n            if (typeof button === 'string') {\n                var name = button;\n                button = {\n                    'name': name\n                };\n            }\n            if (!isOptionAllowed(button.name)) {\n                return;\n            }\n            if (!button.hasOwnProperty('icon')) {\n                button.icon = button.name;\n            }\n            if (!button.hasOwnProperty('title')) {\n                button.title = VPLUtil.str(button.name);\n            }\n            if (!button.hasOwnProperty('active')) {\n                button.active = true;\n            }\n            if (!button.hasOwnProperty('editorName')) {\n                button.editorName = button.name;\n            }\n            if (!button.hasOwnProperty('originalAction')) {\n                button.originalAction = VPLUtil.doNothing;\n            }\n            if (self.notAdded(button.name)) {\n                buttons[button.name] = button;\n            } else {\n                throw new Error(\"Button already set \" + button.name);\n            }\n            self.setAction(button.name, button.originalAction);\n            if (button.hasOwnProperty('bindKey')) {\n                button.command = {\n                    name: button.editorName,\n                    bindKey: button.bindKey,\n                    exec: button.action\n                };\n                var platformStr = '';\n                if (navigator.userAgentData) {\n                    platformStr = navigator.userAgentData.platform;\n                } else if (navigator.platform) {\n                    platformStr = navigator.platform;\n                }\n                var platform = platformStr.startsWith(\"Mac\") ? \"mac\" : \"win\";\n                button.key = button.bindKey[platform];\n            }\n        };\n        this.getHTML = function(buttonName) {\n            if (self.notAdded(buttonName)) {\n                return '';\n            } else {\n                var title = buttons[buttonName].title;\n                if (buttons[buttonName].hasOwnProperty('key')) {\n                    title += ' (' + buttons[buttonName].key + ')';\n                }\n\n                var html = \"<a id='vpl_ide_\" + buttonName + \"' href='#' title='\" + title + \"'>\";\n                html += VPLUI.genIcon(buttons[buttonName].icon) + \"</a>\";\n                return html;\n            }\n        };\n\n        this.enable = function(buttonName, active) {\n            if (self.notAdded(buttonName)) {\n                return;\n            }\n            var bw = $('#vpl_ide_' + buttonName);\n            buttons[buttonName].active = active;\n            bw.data(\"vpl-active\", active);\n            if (!active) {\n                bw.addClass('ui-button-disabled ui-state-disabled');\n            } else {\n                bw.removeClass('ui-button-disabled ui-state-disabled');\n            }\n        };\n        this.setAction = function(buttonName, action) {\n            if (self.notAdded(buttonName)) {\n                return;\n            }\n            buttons[buttonName].originalAction = action;\n            buttons[buttonName].action = function() {\n                if (buttons[buttonName].active) {\n                    action();\n                }\n            };\n        };\n        this.getAction = function(buttonName) {\n            if (self.notAdded(buttonName)) {\n                return VPLUtil.doNothing;\n            }\n            return buttons[buttonName].action;\n        };\n        this.launchAction = function(buttonName) {\n            if (self.notAdded(buttonName)) {\n                return;\n            }\n            buttons[buttonName].originalAction();\n        };\n        this.setGetkeys = function(editor) {\n            if (!editor) {\n                return;\n            }\n            var commands = editor.commands.commands;\n            var platform = editor.commands.platform;\n            for (var buttonName in buttons) {\n                if (buttons.hasOwnProperty(buttonName)) {\n                    var editorName = buttons[buttonName].editorName;\n                    if (commands[editorName] && commands[editorName].bindKey && !buttons[buttonName].Key) {\n                        buttons[buttonName].key = commands[editorName].bindKey[platform];\n                        self.setText(buttonName);\n                    } else {\n                        if (buttons[buttonName].bindKey &&\n                            !buttons[buttonName].hasOwnProperty('key')) {\n                            buttons[buttonName].key = buttons[buttonName].bindKey[platform];\n                            self.setText(buttonName);\n                        }\n                    }\n                }\n            }\n        };\n        this.getShortcuts = function(editor) {\n            var html = '<ul>';\n            for (var buttonName in buttons) {\n                if (buttons[buttonName].hasOwnProperty('key')) {\n                    html += '<li>';\n                    html += buttons[buttonName].title + ' (' + buttons[buttonName].key + ')';\n                    html += '</li>';\n                }\n            }\n            html += '</ul>';\n            if (editor) {\n                html += '<h5>' + VPLUtil.str('edit') + '</h5>';\n                var commands = editor.commands.commands;\n                var platform = editor.commands.platform;\n                html += '<ul>';\n                for (var editorName in commands) {\n                    if (commands[editorName].hasOwnProperty('bindKey') && commands[editorName].bindKey[platform] > '') {\n                        html += '<li>';\n                        html += editorName + ' (' + commands[editorName].bindKey[platform] + ')';\n                        html += '</li>';\n                    }\n                }\n                html += '</ul>';\n            }\n            if (html == '<ul></ul>') {\n                return '';\n            }\n            return html;\n        };\n        $(menuElement).on(\"click\", \"a\", function(event) {\n            if ($(this).data(\"vpl-active\")) {\n                var actionid = $(this).attr('id');\n                if (typeof actionid === 'string' && actionid.startsWith('vpl_ide_')) {\n                    actionid = actionid.replace('vpl_ide_', '');\n                } else {\n                    return true;\n                }\n                if (self.notAdded(actionid)) {\n                    return true;\n                }\n                if (buttons[actionid] && !buttons[actionid].active) {\n                    return true;\n                }\n                var action = self.getAction(actionid);\n                if (actionid != 'import') {\n                    setTimeout(action, 10);\n                } else {\n                    action();\n                }\n            }\n            event.stopImmediatePropagation();\n            return false;\n        });\n\n        $('body').on('keydown', function(event) {\n            var check = false;\n            var strkey = '';\n            if (event.shiftKey) {\n                strkey += 'shift-';\n            }\n            if (event.altKey) {\n                strkey += 'alt-';\n                check = true;\n            }\n            if (event.ctrlKey) {\n                strkey += 'ctrl-';\n                check = true;\n            }\n            if (event.metaKey) {\n                strkey += 'meta-';\n                check = true;\n            }\n            if (event.which >= 112 && event.which <= 123) {\n                strkey += 'f' + (event.which - 111);\n                check = true;\n            } else {\n                var char = String.fromCharCode(event.which).toLowerCase();\n                if (char < 'a' || char > 'z') {\n                    check = false;\n                } else {\n                    strkey += char;\n                }\n            }\n            if (check) {\n                for (var buttonName in buttons) {\n                    if (buttons[buttonName].hasOwnProperty('key')) {\n                        if (strkey == buttons[buttonName].key.toLowerCase()) {\n                            event.preventDefault();\n                            event.stopImmediatePropagation();\n                            buttons[buttonName].action();\n                            return false;\n                        }\n                    }\n                }\n            }\n            return true;\n        });\n        this.multiple = function(v, m) {\n            return v - (v % m);\n        };\n\n        (function() {\n            var start = 0;\n            var lastLap = 0;\n            var interval = false;\n            var hour = 60 * 60;\n            var day = hour * 24;\n            var cssclasses = 'vpl_buttonleft_orange vpl_buttonleft_red vpl_buttonleft_black';\n            var show = false;\n            var element = null;\n            var precision = 5;\n            var checkt = 1000;\n            var timeLeft = 0;\n            var updatePrecision = function(timeLeft) {\n                precision = 5;\n                checkt = 1000;\n                if (timeLeft > hour) {\n                    precision = 60;\n                    checkt = 5000;\n                } else if (timeLeft > day) {\n                    precision = 5 * 60;\n                    checkt = 5 * 5000;\n                }\n            };\n            var updateTimeLeft = function() {\n                var now = self.multiple(VPLUtil.getCurrentTime(), precision);\n                if (now === lastLap || element === null) {\n                    return;\n                }\n                lastLap = now;\n                var tl = timeLeft - (lastLap - start);\n                var cssclass = '';\n                if (tl <= 0) {\n                    cssclass = 'vpl_buttonleft_black';\n                } else if (tl <= 5 * 60) {\n                    show = true;\n                    cssclass = 'vpl_buttonleft_red';\n                } else if (tl <= 15 * 60) {\n                    cssclass = 'vpl_buttonleft_orange';\n                } else {\n                    updatePrecision(tl);\n                }\n                var thtml = '<span class=\"' + cssclass + '\">' + VPLUI.genIcon('timeleft');\n                if (show) {\n                    thtml += ' ' + VPLUtil.getTimeLeft(tl);\n                }\n                thtml += '</span>';\n                element.html(thtml);\n                element.removeClass(cssclasses);\n                element.addClass(cssclass);\n            };\n            self.toggleTimeLeft = function() {\n                show = !show;\n                lastLap = 0;\n                updateTimeLeft();\n            };\n            self.setTimeLeft = function(options) {\n                element = $('#vpl_ide_timeleft');\n                if (interval !== false) {\n                    clearInterval(interval);\n                    interval = false;\n                }\n                if (options.hasOwnProperty('timeLeft')) {\n                    timeLeft = options.timeLeft;\n                    updatePrecision(timeLeft);\n                    var sync = timeLeft % precision;\n                    timeLeft = self.multiple(timeLeft, precision);\n                    start = self.multiple(VPLUtil.getCurrentTime(), precision);\n                    lastLap = start - precision;\n                    setTimeout(function() {\n                        interval = setInterval(updateTimeLeft, checkt);\n                    }, sync * 1000);\n                    $('#vpl_ide_timeleft').show();\n                    updateTimeLeft();\n\n                } else {\n                    $('#vpl_ide_timeleft').hide();\n                }\n            };\n        })();\n    }\n}\n"],"names":["constructor","menuElement","isOptionAllowed","start","lastLap","interval","show","element","precision","checkt","timeLeft","updatePrecision","updateTimeLeft","self","this","buttons","notAdded","buttonName","setText","icon","title","VPLUtil","str","hasOwnProperty","key","attr","replaceWith","VPLUI","genIcon","setExtracontent","html","cl","btag","find","length","append","add","button","name","active","editorName","originalAction","doNothing","Error","setAction","command","bindKey","exec","action","platformStr","navigator","userAgentData","platform","startsWith","getHTML","enable","bw","data","removeClass","addClass","getAction","launchAction","setGetkeys","editor","commands","Key","getShortcuts","on","event","actionid","replace","setTimeout","stopImmediatePropagation","check","strkey","shiftKey","altKey","ctrlKey","metaKey","which","char","String","fromCharCode","toLowerCase","preventDefault","multiple","v","m","hour","now","getCurrentTime","tl","cssclass","thtml","getTimeLeft","toggleTimeLeft","setTimeLeft","options","clearInterval","sync","setInterval","hide"],"mappings":"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"}