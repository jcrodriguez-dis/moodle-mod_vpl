define("mod_vpl/vplideblocklyfile",["exports","jquery","mod_vpl/vplutil"],(function(_exports,_jquery,_vplutil){var obj;
/**
   * Blockly file management
   *
   * @copyright 2013 Juan Carlos Rodríguez-del-Pino
   * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.blocklyExtension=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj};_exports.blocklyExtension=function(){var self=this,vplIdeInstance=this.getVPLIDE();this.firstContent=!0,this.workspaceInstance=!1;var breakpoint,lastSelection,oldAdjustSize=this.adjustSize;this.adjustSize=function(){if(oldAdjustSize.call(this)){var editTag=(0,_jquery.default)(this.getTId());if(0===editTag.length)return!1;var newHeight=editTag.parent().height();return newHeight-=editTag.position().top,editTag.height(newHeight),(0,_jquery.default)("#"+this.bdiv).height(newHeight),(0,_jquery.default)("#"+this.bdiv).width(editTag.width()),Blockly.svgResize(this.workspaceInstance),!1}return!1},this.undo=function(){this.isOpen()&&this.workspaceInstance.undo(!1)},this.redo=function(){this.isOpen()&&this.workspaceInstance.undo(!0)},this.interpreter=!1,this.animateRun=!1,this.RUNSTATE=1,this.STEPSTATE=2,this.STOPSTATE=3,this.executionState=this.STOPSTATE,this.goNext=!1,this.initRun=function(animate){var ter=vplIdeInstance.getTerminal();ter.isConnected()&&ter.closeLocal(),this.animateRun=animate,Blockly.JavaScript.STATEMENT_PREFIX="highlightBlock(%1);\n",Blockly.JavaScript.addReservedWords("highlightBlock");var code=Blockly.JavaScript.workspaceToCode(self.workspaceInstance);self.interpreter=new Interpreter(code,(function(interpreter,scope){interpreter.setProperty(scope,"alert",interpreter.createNativeFunction((function(text){return text="string"!=typeof text?text.toString()+"\r\n":text+"\r\n",interpreter.createPrimitive(ter.writeLocal(text))})));interpreter.setProperty(scope,"prompt",interpreter.createAsyncFunction((function(text,callback){text="string"!=typeof text?text.toString():""+text,ter.writeLocal(text),ter.setDataCallback((function(t){ter.writeLocal("\n"),callback(t)}))})));interpreter.setProperty(scope,"highlightBlock",interpreter.createNativeFunction((function(id){id==self.getBreakpoint()&&(self.executionState=self.STEPSTATE,self.updateRunButtons(),vplIdeInstance.getTerminal().setMessage(_vplutil.VPLUtil.str("breakpoint"))),(self.animateRun||self.executionState==self.STEPSTATE)&&self.workspaceInstance.highlightBlock(id),self.goNext=!1})))})),ter.connectLocal(self.stop,_vplutil.VPLUtil.doNothing)},this.reservedWords={Infinity:!0,Array:!0,Boolean:!0,Date:!0,Error:!0,EvalError:!0,Function:!0,JSON:!0,Math:!0,NaN:!0,Number:!0,Object:!0,RangeError:!0,ReferenceError:!0,RegExp:!0,String:!0,SyntaxError:!0,TypeError:!0,URIError:!0,alert:!0,arguments:!0,constructor:!0,eval:!0,highlightBlock:!0,isFinite:!0,isNaN:!0,parseFloat:!0,parseInt:!0,prompt:!0,self:!0,this:!0,window:!0},breakpoint=null,lastSelection=null,self.getBreakpoint=function(){return breakpoint},self.setBreakpoint=function(){breakpoint=lastSelection},self.removeBreakpoint=function(){breakpoint=null},self.setLastSelection=function(selection){lastSelection=selection},self.isSelectingBreakpoint=function(){return null===breakpoint&&null!==lastSelection},this.getVarValue=function(val){var HTML="";if(null===val)HTML="<b>null</b>";else if(null!=val){var type=typeof val;if("string"==type)HTML='"'+_vplutil.VPLUtil.sanitizeText(val)+'"';else if("boolean"==type)HTML="<b>"+val+"</b>";else if("object"==type&&"Array"===val.class){HTML="[";for(var ar=val.properties,i=0;i<ar.length;i++)HTML+=self.getVarValue(ar[i]),i!=ar.length-1&&(HTML+=", ");HTML+="]"}else"object"==type?HTML="<b>"+val.toString()+"</b>":HTML+=""+val}return HTML},this.getVariables=function(properties){var HTML="";for(var proname in properties)if(!0!==this.reservedWords[proname]){var pro=properties[proname];if(null!=pro&&"Function"!==pro.class)HTML+="<b>"+proname+"</b>:&nbsp;"+_vplutil.VPLUtil.sanitizeText(self.getVarValue(pro))+"<br>\n"}return HTML},this.getParameters=function(args){for(var HTML="(",i=0;i<args.length;i++)HTML+=""+args[i],i<args.length-1&&(HTML+=", ");return HTML+")"},this.showStack=function(interpreter){for(var sn=0,HTML='<table class="generaltable">',stack=interpreter.stateStack,lastFunc="<tr><td>0</td><td><b>Globals</b></td>",i=0;i<stack.length;i++){var level=stack[i];lastFunc>""&&("CallExpression"==level.node.type||i==stack.length-1)&&(HTML+=lastFunc+"<td>"+self.getVariables(level.scope.properties),HTML+="</td></tr>"),"CallExpression"==level.node.type&&(!0!==self.reservedWords[level.node.callee.name]&&null!=level.node.callee.name?(lastFunc="<tr><td>"+ ++sn+"</td>",lastFunc+="<td>"+level.node.callee.name+self.getParameters(level.arguments_)+"</td>"):lastFunc="")}HTML+="</table>",vplIdeInstance.setResult({variables:HTML})},this.runLoop=function(){if(self.interpreter){self.goNext=!0;for(var i=0;i<3e4&&self.goNext&&self.executionState!=self.STOPSTATE;i++)if(!self.interpreter||!self.interpreter.step()){self.executionState=self.STOPSTATE,self.updateRunButtons();break}if(self.executionState==self.STOPSTATE)return self.workspaceInstance.highlightBlock(-1),vplIdeInstance.getTerminal().closeLocal(),void vplIdeInstance.setResult({variables:""});self.executionState==self.RUNSTATE?self.animateRun?(setTimeout(self.runLoop,1e3),self.showStack(self.interpreter)):setTimeout(self.runLoop,0):self.showStack(self.interpreter)}},this.start=function(){self.executionState==self.STOPSTATE&&(self.initRun(!1),self.executionState=self.RUNSTATE,self.updateRunButtons(),vplIdeInstance.getTerminal().setMessage(_vplutil.VPLUtil.str("start")),self.runLoop())},this.startAnimate=function(){self.executionState==self.STOPSTATE&&(self.initRun(!0),self.executionState=self.RUNSTATE,self.updateRunButtons(),vplIdeInstance.getTerminal().setMessage(_vplutil.VPLUtil.str("startanimate")),self.runLoop())},this.stop=function(){self.executionState=self.STOPSTATE,self.workspaceInstance.highlightBlock(-1),self.updateRunButtons(),vplIdeInstance.getTerminal().setMessage(_vplutil.VPLUtil.str("stop")),vplIdeInstance.getTerminal().closeLocal(),self.interpreter=!1,vplIdeInstance.setResult({variables:""})},this.pause=function(){self.executionState==self.RUNSTATE&&(self.executionState=self.STEPSTATE,vplIdeInstance.getTerminal().setMessage(_vplutil.VPLUtil.str("pause")),self.updateRunButtons())},this.resume=function(){self.executionState==self.STEPSTATE&&(self.executionState=self.RUNSTATE,vplIdeInstance.getTerminal().setMessage(_vplutil.VPLUtil.str("resume")),self.updateRunButtons(),self.runLoop())},this.step=function(){self.executionState==self.STOPSTATE&&self.initRun(!0),self.executionState=self.STEPSTATE,self.updateRunButtons(),vplIdeInstance.getTerminal().setMessage(_vplutil.VPLUtil.str("step")),self.runLoop()},this.hasUndo=function(){return!0},this.hasRedo=function(){return!0},this.oldSetFileName=this.setFileName,this.generatorMap={py:"Python",dart:"Dart",js:"JavaScript",lua:"Lua",php:"PHP"},this.generator="",this.setFileName=function(newName){var oldFileName=this.getFileName(),oldExt=_vplutil.VPLUtil.fileExtension(oldFileName);if(!self.oldSetFileName(newName))return _vplutil.VPLUtil.log("Blockly setFileName: name no acepted "+newName),!1;_vplutil.VPLUtil.log("Blockly set filename "+newName);var ext2=/\.([^.]+)\.blockly[123]?$/.exec(newName),fn2=/(.+)\.blockly[123]?$/.exec(newName);return null!==ext2&&null!==fn2&&"string"==typeof this.generatorMap[ext2[1]]?(this.generator=this.generatorMap[ext2[1]],this.generatedFilename=fn2[1],_vplutil.VPLUtil.log("Blockly generator "+this.generator+" for filename "+this.generatedFilename),this.updateGeneratedCode()):this.generator="",oldExt!=_vplutil.VPLUtil.fileExtension(newName)&&(_vplutil.VPLUtil.log("Blockly extension changed"),_vplutil.VPLUtil.afterAll("reopenBlockly",(function(){_vplutil.VPLUtil.log("reopenBlockly"),self.close(),self.open()}))),!0},this.updateGeneratedCode=function(){if(!self.blocklyNotLoaded){var fileManager=self.getFileManager();if(""!=self.generator){_vplutil.VPLUtil.log("Blockly generate "+self.generator);var fid=fileManager.fileNameExists(self.generatedFilename);if(-1==fid&&(_vplutil.VPLUtil.log("try to create "+self.generatedFilename+" files"),fileManager.addFile({name:self.generatedFilename,contents:""},!1,_vplutil.VPLUtil.doNothing,_vplutil.VPLUtil.doNothing),fid=fileManager.fileNameExists(self.generatedFilename)),-1!=fid){var code=Blockly[self.generator].workspaceToCode(self.workspaceInstance),fileGenerated=fileManager.getFile(fid);fileGenerated.getContent()!=code&&(fileGenerated.setContent(code),fileGenerated.change(),fileGenerated.gotoLine(1),fileGenerated.setReadOnly(!0))}}}},this.changeCode=function(event){if(_vplutil.VPLUtil.log(event),"ui"!=event.type||"selected"!=event.element)if("ui"!=event.type||"category"!=event.element||event.newValue!=_vplutil.VPLUtil.str("run")){if(self.firstContent){if("finished_loading"!=event.type)return;self.firstContent=!1,self.workspaceInstance.clearUndo()}event.recordUndo&&(_vplutil.VPLUtil.log("Call change due changeCode"),self.change(),""!=self.generator&&_vplutil.VPLUtil.afterAll("generate"+self.getFileName(),self.updateGeneratedCode))}else _vplutil.VPLUtil.longDelay("updateRunButtons",self.updateRunButtons);else self.setLastSelection(event.newValue)};var triesUpdateRunButtons=0;this.updateRunButtons=function(){if(0==(0,_jquery.default)(".blocklySelectBreakpointC").length)return++triesUpdateRunButtons>20?(triesUpdateRunButtons=0,void _vplutil.VPLUtil.log("Giving up to tries of updateRunButtons")):void _vplutil.VPLUtil.longDelay("updateRunButtons",self.updateRunButtons);_vplutil.VPLUtil.log("updateRunButtons"),triesUpdateRunButtons=0;var dimmed="vpl_dimmed";switch(self.isSelectingBreakpoint()?(0,_jquery.default)(".blocklySelectBreakpointC").removeClass(dimmed):(0,_jquery.default)(".blocklySelectBreakpointC").addClass(dimmed),null===self.getBreakpoint()?(0,_jquery.default)(".blocklyRemoveBreakpointC").addClass(dimmed):(0,_jquery.default)(".blocklyRemoveBreakpointC").removeClass(dimmed),self.executionState){case self.RUNSTATE:(0,_jquery.default)(".blocklyStartC").addClass(dimmed),(0,_jquery.default)(".blocklyStartAnimateC").addClass(dimmed),(0,_jquery.default)(".blocklyStopC").removeClass(dimmed),(0,_jquery.default)(".blocklyPauseC").removeClass(dimmed),(0,_jquery.default)(".blocklyResumeC").addClass(dimmed),(0,_jquery.default)(".blocklyStepC").addClass(dimmed);break;case self.STEPSTATE:(0,_jquery.default)(".blocklyStartC").addClass(dimmed),(0,_jquery.default)(".blocklyStartAnimateC").addClass(dimmed),(0,_jquery.default)(".blocklyStopC").removeClass(dimmed),(0,_jquery.default)(".blocklyPauseC").addClass(dimmed),(0,_jquery.default)(".blocklyResumeC").removeClass(dimmed),(0,_jquery.default)(".blocklyStepC").removeClass(dimmed);break;case self.STOPSTATE:(0,_jquery.default)(".blocklyStartC").removeClass(dimmed),(0,_jquery.default)(".blocklyStartAnimateC").removeClass(dimmed),(0,_jquery.default)(".blocklyStopC").addClass(dimmed),(0,_jquery.default)(".blocklyPauseC").addClass(dimmed),(0,_jquery.default)(".blocklyResumeC").addClass(dimmed),(0,_jquery.default)(".blocklyStepC").removeClass(dimmed)}},this.setToolbox=function(){var toolboxname=_vplutil.VPLUtil.fileExtension(this.getFileName())+"Toolbox";if(!1!==self[toolboxname]){var addUpdateButtons=function(func){return function(){func(),self.updateRunButtons()}},callBacks={blocklyStartButton:this.start,blocklyStartAnimateButton:this.startAnimate,blocklyStopButton:this.stop,blocklyPauseButton:this.pause,blocklyResumeButton:this.resume,blocklyStepButton:this.step,blocklySelectBreakpointButton:this.setBreakpoint,blocklyRemoveBreakpointButton:this.removeBreakpoint},wp=this.workspaceInstance;for(var key in wp.updateToolbox(this[toolboxname]),callBacks)wp.registerButtonCallback(key,addUpdateButtons(callBacks[key]));this.adjustSize()}else _jquery.default.ajax({url:"../editor/blocklytoolboxes/"+toolboxname+".xml",dataType:"text",success:function(data){self[toolboxname]=self.blocklyIn18(data),self.setToolbox()}})},this.open=function(){if(this.showFileName(),self.blocklyNotLoaded)return _vplutil.VPLUtil.loadScript(["/blockly/blockly_compressed.js","/blockly/msg/js/en.js","/blockly/blocks_compressed.js","/blockly/python_compressed.js","/blockly/javascript_compressed.js","/blockly/php_compressed.js","/blockly/lua_compressed.js","/blockly/dart_compressed.js","/acorn/acorn.js","/acorn/interpreter.js"],(function(){_vplutil.VPLUtil.log("Blocklyloaded",!0),void 0===Blockly.PHP.workspaceToCodeOld&&(Blockly.PHP.workspaceToCodeOld=Blockly.PHP.workspaceToCode,Blockly.PHP.workspaceToCode=function(workspace){return"<?php\n"+Blockly.PHP.workspaceToCodeOld(workspace)}),void 0===Blockly.Python.workspaceToCodeOld&&(Blockly.Python.workspaceToCodeOld=Blockly.Python.workspaceToCode,Blockly.Python.workspaceToCode=function(workspace){return"# -*- coding: utf-8 -*-\n"+Blockly.Python.workspaceToCodeOld(workspace)}),self.blocklyNotLoaded=!1,self.open()})),!1;var code=this.getContent();this.setOpen(!0);var fileName=this.getFileName(),horizontalMenu=!1;/.*[0-9]$/.test(_vplutil.VPLUtil.fileExtension(fileName))&&(horizontalMenu=!0);var tid=this.getTId();(0,_jquery.default)(tid).removeClass("ui-widget-content ui-tabs-panel"),(0,_jquery.default)(tid).addClass("ui-corner-bottom"),this.bdiv="bkdiv"+this.getId(),(0,_jquery.default)(tid).html('<div id="'+this.bdiv+'" style="height: 480px; width: 600px;"></div>');var options={toolbox:'<xml><category name="" colour="330"><block type="math_number"></block></category></xml>',media:"../editor/blockly/media/",horizontalLayout:horizontalMenu,zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.2,scaleSpeed:1.05}};return this.workspaceInstance=Blockly.inject(this.bdiv,options),this.setToolbox(),this.firstContent=code>"",self.workspaceInstance.addChangeListener(self.changeCode),this.setContent(code),_vplutil.VPLUtil.adjustBlockly(self.workspaceInstance,10,10),self.workspaceInstance.scrollX=0,self.workspaceInstance.scrollY=0,Blockly.svgResize(self.workspaceInstance),Blockly.resizeSvgContents(self.workspaceInstance),self.setFileName(self.getFileName()),self.adjustSize(),!1};var getContentOld=this.getContent;this.getContent=function(){if(!this.isOpen())return getContentOld.call(this);var xml=Blockly.Xml.workspaceToDom(this.workspaceInstance);return Blockly.Xml.domToPrettyText(xml)};var setContentOld=this.setContent;this.setContent=function(c){if(setContentOld.call(this,c),c.length>0&&this.isOpen()){this.workspaceInstance.clear();var xml=Blockly.Xml.textToDom(c);Blockly.Xml.domToWorkspace(xml,this.workspaceInstance)}},this.close=function(){this.isOpen()&&(setContentOld.call(this,this.getContent()),this.workspaceInstance.dispose(),this.workspaceInstance=!1,this.setOpen(!1))},this.blocklyNotLoaded=!0,this.blocklyToolbox=!1,this.blockly0Toolbox=!1,this.blockly1Toolbox=!1,this.blockly2Toolbox=!1,this.blockly3Toolbox=!1,this.blocklyStrs=["basic","intermediate","advanced","variables","operatorsvalues","control","inputoutput","functions","lists","math","text","run","start","startanimate","stop","pause","resume","step","breakpoint","selectbreakpoint","removebreakpoint"],this.blocklyIn18=function(data){for(var l=this.blocklyStrs.length,i=0;i<l;i++){var str=this.blocklyStrs[i],reg=new RegExp("\\[\\["+str+"\\]\\]","g"),rep=_vplutil.VPLUtil.str(str);data=data.replace(reg,rep)}return data},this.langSelection=function(){this.setLang("Blockly")}}}));

//# sourceMappingURL=vplideblocklyfile.min.js.map