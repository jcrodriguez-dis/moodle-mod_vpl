/**
 * IDE Buttons
 *
 * @copyright 2016 Juan Carlos Rodríguez-del-Pino
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>
 */
define("mod_vpl/vplidebutton",["jquery","jqueryui","mod_vpl/vplutil"],(function($,jqui,VPLUtil){if(void 0!==VPLIDEButtons)return VPLIDEButtons;var VPLIDEButtons=function(menuElement,isOptionAllowed){var start,lastLap,interval,show,element,precision,checkt,timeLeft,updatePrecision,updateTimeLeft,self=this,buttons={};this.notAdded=function(buttonName){return!buttons[buttonName]},this.setText=function(buttonName,icon,title){self.notAdded(buttonName)||(icon||(icon=buttons[buttonName].icon),title||(title=buttons[buttonName].title),title||(title=VPLUtil.str(icon)),buttons[buttonName].icon=icon,buttons[buttonName].title=title,buttons[buttonName].hasOwnProperty("key")&&(title+=" ("+buttons[buttonName].key+")"),$("#vpl_ide_"+buttonName).attr("title",title),$("#vpl_ide_"+buttonName+" i").replaceWith(VPLUtil.genIcon(icon)))},this.setExtracontent=function(buttonName,html){if(!self.notAdded(buttonName)){var cl="bt_extrahtml",btag=$("#vpl_ide_"+buttonName+" i");0==btag.find("."+cl).length&&btag.append(' <span class="'+cl+'"><span>'),btag.find("."+cl).html(html)}},this.add=function(button){"string"==typeof button&&(button={name:button});if(isOptionAllowed(button.name)){if(button.hasOwnProperty("icon")||(button.icon=button.name),button.hasOwnProperty("title")||(button.title=VPLUtil.str(button.name)),button.hasOwnProperty("active")||(button.active=!0),button.hasOwnProperty("editorName")||(button.editorName=button.name),button.hasOwnProperty("originalAction")||(button.originalAction=VPLUtil.doNothing),!self.notAdded(button.name))throw new Error("Button already set "+button.name);if(buttons[button.name]=button,self.setAction(button.name,button.originalAction),button.hasOwnProperty("bindKey")){button.command={name:button.editorName,bindKey:button.bindKey,exec:button.action};var platform="win";navigator.platform.startsWith("Mac")&&(platform="mac"),button.key=button.bindKey[platform]}}},this.getHTML=function(buttonName){if(self.notAdded(buttonName))return"";var title=buttons[buttonName].title;buttons[buttonName].hasOwnProperty("key")&&(title+=" ("+buttons[buttonName].key+")");var html="<a id='vpl_ide_"+buttonName+"' href='#' title='"+title+"'>";return html+=VPLUtil.genIcon(buttons[buttonName].icon)+"</a>"},this.enable=function(buttonName,active){if(!self.notAdded(buttonName)){var bw=$("#vpl_ide_"+buttonName);buttons[buttonName].active=active,bw.data("vpl-active",active),active?bw.removeClass("ui-button-disabled ui-state-disabled"):bw.addClass("ui-button-disabled ui-state-disabled")}},this.setAction=function(buttonName,action){self.notAdded(buttonName)||(buttons[buttonName].originalAction=action,buttons[buttonName].action=function(){buttons[buttonName].active&&action()})},this.getAction=function(buttonName){return self.notAdded(buttonName)?VPLUtil.doNothing:buttons[buttonName].action},this.launchAction=function(buttonName){self.notAdded(buttonName)||buttons[buttonName].originalAction()},this.setGetkeys=function(editor){if(editor){var commands=editor.commands.commands,platform=editor.commands.platform;for(var buttonName in buttons)if(buttons.hasOwnProperty(buttonName)){var editorName=buttons[buttonName].editorName;commands[editorName]&&commands[editorName].bindKey&&!buttons[buttonName].Key?(buttons[buttonName].key=commands[editorName].bindKey[platform],self.setText(buttonName)):buttons[buttonName].bindKey&&!buttons[buttonName].hasOwnProperty("key")&&(buttons[buttonName].key=buttons[buttonName].bindKey[platform],self.setText(buttonName))}}},this.getShortcuts=function(editor){var html="<ul>";for(var buttonName in buttons)buttons[buttonName].hasOwnProperty("key")&&(html+="<li>",html+=buttons[buttonName].title+" ("+buttons[buttonName].key+")",html+="</li>");if(html+="</ul>",editor){html+="<h5>"+VPLUtil.str("edit")+"</h5>";var commands=editor.commands.commands,platform=editor.commands.platform;for(var editorName in html+="<ul>",commands)commands[editorName].hasOwnProperty("bindKey")&&commands[editorName].bindKey[platform]>""&&(html+="<li>",html+=editorName+" ("+commands[editorName].bindKey[platform]+")",html+="</li>");html+="</ul>"}return"<ul></ul>"==html?"":html},$(menuElement).on("click","a",(function(event){if($(this).data("vpl-active")){var actionid=$(this).attr("id");if("string"!=typeof actionid||!actionid.startsWith("vpl_ide_"))return!0;if(actionid=actionid.replace("vpl_ide_",""),self.notAdded(actionid))return!0;if(buttons[actionid]&&!buttons[actionid].active)return!0;var action=self.getAction(actionid);"import"!=actionid?setTimeout(action,10):action()}return event.stopImmediatePropagation(),!1})),$("body").on("keydown",(function(event){var check=!1,strkey="";if(event.shiftKey&&(strkey+="shift-"),event.altKey&&(strkey+="alt-",check=!0),event.ctrlKey&&(strkey+="ctrl-",check=!0),event.metaKey&&(strkey+="meta-",check=!0),event.which>=112&&event.which<=123)strkey+="f"+(event.which-111),check=!0;else{var char=String.fromCharCode(event.which).toLowerCase();char<"a"||char>"z"?check=!1:strkey+=char}if(check)for(var buttonName in buttons)if(buttons[buttonName].hasOwnProperty("key")&&strkey==buttons[buttonName].key.toLowerCase())return event.preventDefault(),event.stopImmediatePropagation(),buttons[buttonName].action(),!1;return!0})),this.multiple=function(v,m){return v-v%m},start=0,lastLap=0,interval=!1,show=!1,element=null,precision=5,checkt=1e3,timeLeft=0,updatePrecision=function(timeLeft){precision=5,checkt=1e3,timeLeft>3600?(precision=60,checkt=5e3):timeLeft>86400&&(precision=300,checkt=25e3)},updateTimeLeft=function(){var now=self.multiple(VPLUtil.getCurrentTime(),precision);if(now!==lastLap&&null!==element){var tl=timeLeft-((lastLap=now)-start),cssclass="";tl<=0?cssclass="vpl_buttonleft_black":tl<=300?(show=!0,cssclass="vpl_buttonleft_red"):tl<=900?cssclass="vpl_buttonleft_orange":updatePrecision(tl);var thtml='<span class="'+cssclass+'">'+VPLUtil.genIcon("timeleft");show&&(thtml+=" "+VPLUtil.getTimeLeft(tl)),thtml+="</span>",element.html(thtml),element.removeClass("vpl_buttonleft_orange vpl_buttonleft_red vpl_buttonleft_black"),element.addClass(cssclass)}},self.toggleTimeLeft=function(){show=!show,lastLap=0,updateTimeLeft()},self.setTimeLeft=function(options){if(element=$("#vpl_ide_timeleft"),!1!==interval&&(clearInterval(interval),interval=!1),options.hasOwnProperty("timeLeft")){timeLeft=options.timeLeft,updatePrecision(timeLeft);var sync=timeLeft%precision;timeLeft=self.multiple(timeLeft,precision),start=self.multiple(VPLUtil.getCurrentTime(),precision),lastLap=start-precision,setTimeout((function(){interval=setInterval(updateTimeLeft,checkt)}),1e3*sync),$("#vpl_ide_timeleft").show(),updateTimeLeft()}else $("#vpl_ide_timeleft").hide()}};return window.VPLIDEButtons=VPLIDEButtons,VPLIDEButtons}));

//# sourceMappingURL=vplidebutton.min.js.map