define("mod_vpl/vplterminal",["exports","jquery","jqueryui","core/url","mod_vpl/vplutil","mod_vpl/vplui","mod_vpl/vplclipboard"],(function(_exports,_jquery,_jqueryui,_url,_vplutil,_vplui,_vplclipboard){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.VPLTerminal=void 0,_jquery=_interopRequireDefault(_jquery),_jqueryui=_interopRequireDefault(_jqueryui),_url=_interopRequireDefault(_url);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_exports.VPLTerminal=function(dialogId,terminalId,str){var terminal,fitAddon,self=this,ws=null,onCloseAction=_vplutil.VPLUtil.doNothing,title="",message="",tdialog=(0,_jquery.default)("#"+dialogId),tIde=(0,_jquery.default)("#vplide"),titleText="",clipboard=null,clipboardData="",terminalTag=(0,_jquery.default)("#"+terminalId);function receiveClipboard(data){if((clipboardData+=data).length>64e3){var from=clipboardData.length-32e3;clipboardData=clipboardData.substr(from)}}function updateClipboard(){clipboard.setEntry1(clipboardData)}function openClipboard(){updateClipboard(),clipboard.show()}this.updateTitle=function(){var text=title;""!==message&&(text+=" ("+message+")"),titleText.text(str("console")+": "+text)},this.setTitle=function(t){title=t,this.updateTitle()},this.setMessage=function(t){message=t,this.updateTitle()},this.write=function(text){return terminal.write(text),text},this.connect=function(server,onClose){onCloseAction=onClose,"WebSocket"in window?(terminal.reset(),self.show(),ws&&ws.close(),clipboardData="",self.startBlinking(),self.setMessage(""),self.setTitle(str("connecting")),(ws=new WebSocket(server)).writeBuffer="",ws.writeIt=function(){terminal.write(ws.writeBuffer),receiveClipboard(ws.writeBuffer),ws.writeBuffer=""},ws.onmessage=function(event){ws.writeBuffer.length>0?ws.writeBuffer+=event.data:(ws.writeBuffer=event.data,setTimeout(ws.writeIt,35))},ws.onopen=function(){self.setMessage(""),self.setTitle(str("connected"))},ws.onclose=function(){self.setTitle(str("connection_closed")),terminal.blur(),self.stopBlinking(),onClose(),ws.stopOutput=!0}):terminal.write("WebSocket not available: Upgrade your browser")},this.writeLocal=function(text){return ws.onmessage({data:text}),text},this.setDataCallback=function(call){ws.onData=call},this.closeLocal=function(){ws&&(ws.writeIt(),ws.close(),self.setTitle(str("connection_closed")),terminal.blur(),onCloseAction(),ws.stopOutput=!0),self.stopBlinking()},this.connectLocal=function(onClose,onData){onCloseAction=onClose,terminal.reset(),self.show(),ws&&ws.close(),clipboardData="",self.setMessage(""),self.setTitle(str("running")),self.startBlinking(),(ws={}).onData=onData,ws.writeBuffer="",ws.readBuffer="",ws.readyState=1,ws.OPEN=1,ws.close=function(){ws=!1,self.stopBlinking()},ws.onmessage=function(event){ws.writeBuffer=event.data,ws.writeIt()},ws.writeIt=function(){ws&&(terminal.write(ws.writeBuffer),receiveClipboard(ws.writeBuffer),ws.writeBuffer="")},ws.send=function(text){""==text?ws.readBuffer.length>0&&(self.writeLocal("\b \b"),ws.readBuffer=ws.readBuffer.substr(0,ws.readBuffer.length-1)):(self.writeLocal(text),ws.readBuffer+=text);var pos=ws.readBuffer.indexOf("\r");if(-1!=pos){var data=ws.readBuffer.substr(0,pos);ws.readBuffer=ws.readBuffer.substr(pos+1),ws.onData(data)}}},this.isOpen=function(){return tdialog.dialog("isOpen")},this.close=function(){tdialog.dialog("close"),self.stopBlinking()},this.isConnected=function(){return ws&&ws.readyState!=ws.CLOSED},this.disconnect=function(){this.isConnected()&&(onCloseAction(),ws.close(),this.stopBlinking())};var HTMLUpdateClipboard=_vplui.VPLUI.genIcon("copy","sw")+" "+str("copy"),HTMLPaste=_vplui.VPLUI.genIcon("paste","sw")+" "+str("paste");function setTheme(theme){var cbase="vpl_terminal_theme";tdialog.data("terminal_theme",theme),_vplutil.VPLUtil.setUserPreferences({terminalTheme:theme});for(var i=0;i<5;i++)tdialog.removeClass(cbase+i);tdialog.addClass(cbase+theme)}function controlDialogSize(){var bw=tIde.width(),bh=tIde.height();tdialog.width()>bw&&tdialog.dialog("option","width",bw),tdialog.parent().height()>bh&&tdialog.dialog("option","height",bh-tdialog.prev().outerHeight());terminalTag.width(tdialog.width()-13),terminalTag.height(tdialog.height()-13),fitAddon.fit(),terminal.focus()}clipboard=new _vplclipboard.VPLClipboard("vpl_dialog_terminal_clipboard",HTMLUpdateClipboard,(function(){updateClipboard(),document.execCommand("copy")}),HTMLPaste,(function(){ws&&ws.readyState==ws.OPEN&&ws.send(clipboard.getEntry2())})),this.closeDialog=function(){clipboard.hide(),self.disconnect()},tdialog.dialog({closeOnEscape:!1,autoOpen:!1,width:"auto",height:"auto",resizable:!0,dragStop:controlDialogSize,open:controlDialogSize,focus:function(){controlDialogSize(),terminal.focus()},classes:{"ui-dialog":"vpl_ide vpl_vnc"},create:function(){titleText=_vplui.VPLUI.setTitleBar(tdialog,"console","console",["clipboard","keyboard","theme"],[openClipboard,function(){terminal.focus()},function(){setTheme((tdialog.data("terminal_theme")+1)%5)}])},close:function(){self.stopBlinking(),self.closeDialog()},resizeStop:function(){tdialog.width(tdialog.parent().width()),tdialog.height(tdialog.parent().height()-tdialog.prev().outerHeight()),controlDialogSize(),fitAddon.fit(),terminal.focus()}}),this.setFontSize=function(size){terminalTag.css("font-size",size+"px")},_vplutil.VPLUtil.getUserPreferences((function(data){setTheme(data.preferences.terminalTheme)})),tdialog.css("padding","1px"),tdialog.parent().css("z-index",2e3),this.show=function(){tdialog.dialog("open"),terminal.focus(),fitAddon.fit()},this.startBlinking=function(){terminal.options.cursorBlink||(_vplutil.VPLUtil.log("Terminal: cursor start blinking"),terminal.options.cursorBlink=!0)},this.stopBlinking=function(){terminal.options.cursorBlink&&(_vplutil.VPLUtil.log("Terminal: cursor stop blinking"),terminal.options.cursorBlink=!1)},this.init=async function(){const libpath=_url.default.relativeUrl("/mod/vpl/thirdpartylibs/xterm/"),link=document.createElement("link");link.rel="stylesheet",link.href=libpath+"xterm.css",document.head.appendChild(link);const xterm=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require([libpath+"xterm.js"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(libpath+"xterm.js")):Promise.resolve(_systemImportTransformerGlobalIdentifier[libpath+"xterm.js"])),xtermFit=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require([libpath+"addon-fit/addon-fit.js"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(libpath+"addon-fit/addon-fit.js")):Promise.resolve(_systemImportTransformerGlobalIdentifier[libpath+"addon-fit/addon-fit.js"]));terminal=new xterm.Terminal({scrollback:5e3}),fitAddon=new xtermFit.FitAddon,terminal.loadAddon(fitAddon),self.stopBlinking(),terminal.onData((function(data){ws&&ws.readyState==ws.OPEN&&ws.send(data)})),terminal.open(terminalTag[0]),terminal.reset()},this.init()}}));

//# sourceMappingURL=vplterminal.min.js.map