define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard","core/log"],function(a,b,c,d,e){window.INCLUDE_URI="../editor/noVNC/include/",Util.load_scripts(["webutil.js","base64.js","websock.js","des.js","keysymdef.js","keyboard.js","input.js","display.js","jsunzip.js","rfb.js","keysym.js"]);var f=function(b,f){function g(){var a=B.value;if(a!=D||a!=C){var b=Math.min(a.length,D.length),c=0;for(c=0;c<b&&a.charAt(c)==D.charAt(c);c++);for(var d=D.length-1;d>=a.length;d--)t.sendBackspace();c<a.length&&t.send(a.substr(c)),D=a,(a.length>500||0===a.length)&&(B.blur(),setTimeout(function(){B.focus(),B.value=C,D=C;try{B.setSelectionRange(C.length,C.length)}catch(a){}},10))}}function h(){a(B).is(":focus")?B.blur():B.focus()}function i(){t.isConnected()&&q.clipboardPasteFrom(r.getEntry2())}function j(a,b){r.setEntry1(b)}function k(){r.show()}function l(){t.isConnected()&&q.get_keyboard().set_focused(!0)}function m(){t.isConnected()&&q.get_keyboard().set_focused(!1)}function n(){r.setEntry1(r.getEntry1()),document.execCommand("copy")}function o(a,b,c,d){switch(w=b,b){case"normal":t.setMessage(""),t.setTitle(f("connected"));break;case"disconnect":case"disconnected":t.setTitle(f("connection_closed"));break;case"failed":t.setTitle(f("connection_fail")),e.log("VNC client: "+d);break;default:t.setMessage(""),t.setTitle(f("connecting"))}}function p(a){return a<100&&(a=100),2*Math.floor(a/2)}var q,r,s,t=this,u="",v="",w="",x=a("#"+b),y=a("#"+b+" canvas"),z=function(){},A=!0,B=window.document.createElement("input");B.style.position="absolute",B.style.left="0px",B.style.top="-10000px",B.style.width="1em",B.style.height="1ex",B.style.opacity="0",B.style.backgroundColor="transparent",B.style.borderStyle="none",B.style.outlineStyle="none",B.autocapitalize="off",B.autocomplete="off",B.autocorrect="off",B.wrap="off",B.spellcheck="false",x.append(B);var C="_________________________________________________________",D=C;if(c.isAndroid()&&c.isFirefox()){this.send=function(a){for(var b=0;b<a.length;b++)q.sendKey(a.charCodeAt(b))},this.sendBackspace=function(){q.sendKey(65288)},B.value=C,B.focus();try{B.setSelectionRange(C.length,C.length)}catch(E){}a(B).on("change",function(){g(),t.send("\r")}),a(B).on("input",function(){g()}),a(B).on("keypress",function(a){a.stopImmediatePropagation()}),a(B).on("focus",function(){B.value=C,D=C;try{B.setSelectionRange(C.length,C.length)}catch(a){}})}var F=c.gen_icon("copy","sw")+" "+f("copy"),G=c.gen_icon("paste","sw")+" "+f("paste");r=new d("vpl_dialog_vnc_clipboard",F,n,G,i,m),y.on("click",function(a){a.target==y[0]?l():m()}),this.displayResize=function(){if(t.isConnected()){var a=x.width(),b=x.height();t.setCanvasSize(a,b),q.get_display().viewportChange(0,0,a,b)}},x.dialog({closeOnEscape:!1,autoOpen:!1,modal:!0,width:"auto",height:"auto",dialogClass:"vpl_ide vpl_vnc",create:function(){s=c.setTitleBar(x,"vnc","graphic",["clipboard","keyboard"],[k,h])},focus:l,beforeClose:function(){if(A){var a=x.width(),b=x.height();A=!1,t.setCanvasSize(a,b)}},close:function(){t.disconnect()},resizeStop:function(){A=!0}}),x.css("padding","1px"),this.updateTitle=function(){var a=u;""!==v&&(a+=" ("+v+")"),s.text(f("console")+": "+a)},this.setTitle=function(a){u=a,this.updateTitle()},this.setMessage=function(a){v=a,this.updateTitle()},this.connect=function(c,d,e,f,g,h){r.setEntry1(""),z=h,t.show();var i=a("#"+b+" canvas")[0];q||(q=new RFB({target:i,encrypt:c,repeaterID:"",true_color:!0,local_cursor:!0,shared:!1,view_only:!1,onUpdateState:o,onPasswordRequired:null,onClipboard:j}),q.set_local_cursor(q.get_display().get_cursor_uri())),e||(e=c?443:80),q.connect(d,e,f,g)},this.isOpen=function(){return x.dialog("isOpen")},this.isConnected=function(){return q&&"disconnected"!=w},this.disconnect=function(){q&&"normal"==w&&q.disconnect(),z(),r.hide()},this.getCanvasSize=function(){return y.width()+"x"+y.height()},this.setCanvasSize=function(a,b){y.width(p(a)),y.height(p(b))},this.show=function(){x.dialog("open"),x.width("auto"),x.height("auto")},t.setCanvasSize(a(window).width()-150,a(window).height()-150)};return f});