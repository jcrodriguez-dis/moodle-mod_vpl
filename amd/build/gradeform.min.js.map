{"version":3,"file":"gradeform.min.js","sources":["../src/gradeform.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript functions to help grade form\n * @copyright 2012 Juan Carlos Rodr√≠guez-del-Pino, 2021 Astor Bizard\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\n/**\n * Apply grade reduction comments to given grade.\n * @param {Number} grade Original grade.\n * @param {String} comments Comments with some grade reduction.\n * @returns {Number} The reduced grade.\n */\nfunction reduceGradeWithComments(grade, comments) {\n    var regDiscount = /^-.+\\((-[0-9.]+)\\)\\s*$/gm;\n    var match;\n    while ((match = regDiscount.exec(comments)) !== null) {\n        var rest = parseFloat(match[1]);\n        if (rest < 0) {\n            grade += rest;\n        }\n    }\n    return grade;\n}\n\n/**\n * Format grade (in points) to a displayable float.\n * @param {Number} grade Grade to be formatted.\n * @returns {Number} The formatted grade.\n */\nfunction formatGrade(grade) {\n    // No negative grade.\n    if (grade < 0) {\n        return 0;\n    }\n    // Max two decimal points.\n    return Math.round(100 * grade) / 100;\n}\n\n/**\n * Init method for grade buttons (Merge grade, Calculate).\n */\nfunction setupGradeButtons() {\n    // Calculate button.\n    $('button[data-role=\"calculategrade\"]').click(function() {\n        // Recalculate numeric grade from the max grade,\n        // substracting points found at the end of lines.\n        // Valid reduction format: \"- text (-grade)\".\n        var $form = $(this).closest('form');\n        var text = $form.find('[name=\"comments\"]').val();\n        var grade = parseFloat($(this).data('maxgrade'));\n        grade = formatGrade(reduceGradeWithComments(grade, text));\n        $form.find('[name=\"grade\"]').val(grade);\n    });\n\n    // Merge grade button.\n    $('button[data-role=\"mergegrade\"]').click(function() {\n        // Merge numeric grade from the proposed grade and advancedgrading grid,\n        // substracting points found at the end of lines.\n        // Valid reduction format: \"- text (-grade)\".\n        var $form = $(this).closest('form');\n        var gridpoints = 0;\n        if ($form.find('.score .scorevalue').length > 0) {\n            $form.find('.checked .score .scorevalue')\n            .each(function() {\n                gridpoints += Number($(this).text());\n            });\n        } else {\n            $form.find('.score input')\n            .each(function() {\n                gridpoints += Number($(this).val());\n            });\n        }\n        var advancedgradingcomments = '';\n        $form.find('.criterion .remark textarea')\n        .each(function() {\n            advancedgradingcomments += $(this).val() + \"\\n\";\n        });\n        gridpoints = reduceGradeWithComments(gridpoints, advancedgradingcomments);\n\n        var maxgrade = $(this).data('maxgrade');\n        var currentgrade = $(this).data('currentgrade');\n        var maxgridpoints = $(this).data('maxgridpoints');\n\n        var grade = formatGrade(currentgrade - maxgridpoints * (currentgrade / maxgrade) + gridpoints);\n        $form.find('[name=\"grade\"]').val(grade);\n\n        var $comments = $form.find('[name=\"comments\"]');\n        var text = $comments.val();\n\n        var gridtag = '#Grid grade';\n        var gridcomment = gridtag + ': ' + grade;\n        if (text.search(gridtag) < 0) {\n            text = gridcomment + \"\\n\" + text;\n        } else {\n            text = text.replace(new RegExp(gridtag + '.*'), gridcomment);\n        }\n        var proposedtag = '#Proposed grade';\n        var proposedcomment = proposedtag + ': ' + currentgrade;\n        if (text.search(proposedtag) < 0) {\n            text = proposedcomment + \"\\n\" + text;\n        } else {\n            text = text.replace(new RegExp(proposedtag + '.*'), proposedcomment);\n        }\n\n        $comments.val(text);\n    });\n}\n\n/**\n * Init method for import buttons.\n */\nfunction setupImportButtons() {\n    $('button[data-role=\"importfromsub\"]').click(function() {\n        var $form = $(this).closest('form');\n        // Set grade and comments.\n        $form.find('[name=\"grade\"]').val($(this).data('grade'));\n        $form.find('[name=\"comments\"]').val($(this).data('comments'));\n\n        // Set advanced grading data:\n\n        // First, reset the fields.\n        $('#advancedgrading-criteria .criterion .remark textarea').val('');\n        $('#advancedgrading-criteria .criterion .score input').val('');\n        // Handle rubric level selection slightly differently:\n        // we trigger a click on it, so it updates its UI correctly.\n        $('#advancedgrading-criteria .criterion .level.checked').click();\n\n        // Then, set the fields to their new values.\n        $(this).data('advgrading').forEach(function(criterion) {\n            var id = criterion.criterionid;\n            if (typeof (criterion.remark) !== 'undefined') {\n                $form.find('[name=\"advancedgrading[criteria][' + id + '][remark]\"]').val(criterion.remark);\n            }\n            if (typeof (criterion.score) !== 'undefined') {\n                $form.find('[name=\"advancedgrading[criteria][' + id + '][score]\"]').val(parseFloat(criterion.score));\n            }\n            // Handle rubric level selection slightly differently:\n            // we trigger a click on it, so it updates its UI correctly.\n            if (typeof (criterion.levelid) !== 'undefined') {\n                $('#advancedgrading-criteria-' + id + '-levels-' + criterion.levelid).click();\n            }\n        });\n    });\n}\n\n/**\n * Setup the get grade comment list button.\n * @param {Number} id The id of course module instance of the VPL activity.\n */\nexport const setupGetGradeCommentList = (id) => {\n    $('#vpl_load_grading_help').on('click', function() {\n        var panel = $('#vpl_grading_help_panel');\n        // Remove the button.\n        $(this).remove();\n        // Show loading spinner.\n        const spinner = '<i class=\"icon fa fa-spinner fa-pulse fa-fw \" aria-hidden=\"true\"></i>';\n        panel.removeClass('d-none');\n        panel.addClass('flex-grow-1');\n        panel.html(M.util.get_string('loading', 'moodle') + ' ' + spinner);\n        $.ajax({\n            method: 'GET',\n            url: M.cfg.wwwroot + '/mod/vpl/forms/grading_help.php?id=' + id,\n            success: function(data) {\n                const textarea = $('#id_comments');\n                textarea.css('margin-right', '1em');\n                textarea.css('resize', 'both');\n                panel.css('overflow-y', 'scroll');\n                if (data.success) {\n                    panel.html(data.response);\n                } else {\n                    panel.html(data.error);\n                }\n                window.VPL.resizeSView();\n                setInterval(window.VPL.resizeSView, 5000);\n            },\n            error: function() {\n                panel.html(M.util.get_string('error', 'moodle'));\n            },\n        });\n    });\n};\n\n/**\n * Setup the grade form JS features.\n * @param {Number} id The id of course module instance of the VPL activity.\n */\nexport const setup = (id) => {\n    setupGradeButtons();\n    setupImportButtons();\n    setupGetGradeCommentList(id);\n};\n\n/**\n * Update the submission list in the opener window with the new grade data.\n * If nexturl is given, go to the next submission after updating.\n * @param {Number} submissionID The submission being graded.\n * @param {Object} gradeData The new grade data.\n * @param {String} nexturl URL of the next submission to be graded (if any).\n */\nexport const updateSubmissionsList = (submissionID, gradeData, nexturl) => {\n    if (opener !== null) {\n        $(opener.document).find('#g' + submissionID).html(gradeData.grade);\n        $(opener.document).find('#m' + submissionID).html(gradeData.grader);\n        $(opener.document).find('#o' + submissionID).html(gradeData.gradedon);\n        $(opener.document).find('#c' + submissionID).html(gradeData.comments);\n        $(opener.document).find('.gd' + submissionID).css('color', '').css('backgroundColor', '');\n    }\n    if (nexturl) {\n        if (opener === null) {\n            window.close();\n        }\n        var nextrow = $(opener.document).find('#g' + submissionID).closest('tr').next();\n        if (nextrow.length == 0) {\n            window.close();\n        }\n        var nextid = nextrow.html().match(/user\\/view\\.php\\?(.*?)id=([0-9]+)/)[2];\n        if (nextid) {\n            location.replace(nexturl + nextid);\n        } else {\n            window.close();\n        }\n    }\n};\n\n/**\n * Highlight the submission being graded in the opener window.\n * @param {Number} submissionID The submission being graded.\n */\nexport const highlightSubmission = (submissionID) => {\n    if (opener !== null) {\n        $(opener.document).find('.gd' + submissionID).css('color', 'black').css('backgroundColor', 'yellow');\n        window.addEventListener('pagehide', function() {\n            $(opener.document).find('.gd' + submissionID).css('color', '').css('backgroundColor', '');\n        });\n    }\n};\n\n(function() {\n    if (typeof window.VPL != 'object') {\n        window.VPL = {};\n    }\n    /**\n     * Add new comment to the textarea granding comments field.\n     *\n     * @param {string} comment Comment to add\n     */\n    window.VPL.addComment = function(comment) {\n        if (!comment) {\n            return;\n        }\n        const field = document.getElementById('id_comments');\n        if (!field) {\n            return;\n        }\n        // Comment content removing last (-number) if any.\n        const cleanComment = comment.replace(/\\(\\s*-\\s*\\d(\\.\\d+)?\\s*\\)\\s*$/, '');\n        const formattedComment = '-' + comment + '\\n';\n        const currentText = field.value;\n        // Prevent duplicates\n        const foundIndex = currentText.indexOf(cleanComment);\n        if (foundIndex !== -1) {\n            field.setSelectionRange(foundIndex, foundIndex + cleanComment.length);\n            field.scrollTop = field.scrollHeight * (foundIndex / currentText.length);\n            field.focus();\n            return;\n        }\n        // Get cursor position and selection\n        const endPos = field.selectionEnd;\n        let textToInsert = formattedComment;\n        // Find the position to insert the comment: at the end of the current line\n        const nextNewLine = currentText.indexOf('\\n', endPos);\n        let insertpos;\n        if (nextNewLine === -1) {\n            insertpos = currentText.length;\n            if (insertpos > 0 && currentText.charAt(insertpos - 1) !== '\\n') {\n                textToInsert = '\\n' + textToInsert;\n            }\n        } else {\n            insertpos = nextNewLine + 1;\n        }\n\n        // Insert text and select it\n        field.setRangeText(textToInsert, insertpos, insertpos, 'select');\n        // Focus the field\n        field.focus();\n        field.dispatchEvent(new Event('input', {bubbles: true}));\n    };\n\n    /**\n     * Resize the grading help side view to match the comments textarea size.\n     */\n    window.VPL.resizeSView = function() {\n        const commentsView = window.document.getElementById('vpl_grading_help_panel');\n        const textarea = window.document.getElementById('id_comments');\n        if (commentsView && textarea) {\n            const parent = commentsView.parentElement;\n            const newHeight = textarea.offsetHeight;\n            if (newHeight != commentsHeight) {\n                commentsHeight = newHeight;\n                commentsView.style.height = commentsHeight + 'px';\n            }\n            const newWidth = parent.clientWidth - textarea.offsetWidth - 20;\n            if (newWidth > 200 && newWidth != commentsWidth) {\n                commentsWidth = newWidth;\n                commentsView.style.width = commentsWidth + 'px';\n            }\n        }\n    };\n\n    // Call resize when the window is resized.\n    var commentsHeight = 0;\n    var commentsWidth = 0;\n    window.addEventListener('resize', window.VPL.resizeSView);\n})();"],"names":["reduceGradeWithComments","grade","comments","match","regDiscount","exec","rest","parseFloat","formatGrade","Math","round","setupGetGradeCommentList","id","on","panel","this","remove","removeClass","addClass","html","M","util","get_string","ajax","method","url","cfg","wwwroot","success","data","textarea","css","response","error","window","VPL","resizeSView","setInterval","click","$form","closest","text","find","val","gridpoints","length","each","Number","advancedgradingcomments","maxgrade","currentgrade","$comments","gridcomment","gridtag","proposedcomment","proposedtag","search","replace","RegExp","forEach","criterion","criterionid","remark","score","levelid","submissionID","gradeData","nexturl","opener","document","grader","gradedon","close","nextrow","next","nextid","location","addEventListener","addComment","comment","field","getElementById","cleanComment","formattedComment","currentText","value","foundIndex","indexOf","setSelectionRange","scrollTop","scrollHeight","focus","endPos","selectionEnd","textToInsert","nextNewLine","insertpos","charAt","setRangeText","dispatchEvent","Event","bubbles","commentsView","parent","parentElement","newHeight","offsetHeight","commentsHeight","style","height","newWidth","clientWidth","offsetWidth","commentsWidth","width"],"mappings":"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"}