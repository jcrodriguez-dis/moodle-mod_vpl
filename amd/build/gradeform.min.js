define("mod_vpl/gradeform",["exports","jquery"],(function(_exports,_jquery){var obj;
/**
   * JavaScript functions to help grade form
   * @copyright 2012 Juan Carlos Rodr√≠guez-del-Pino, 2021 Astor Bizard
   * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */function reduceGradeWithComments(grade,comments){for(var match,regDiscount=/^-.+\((-[0-9.]+)\)\s*$/gm;null!==(match=regDiscount.exec(comments));){var rest=parseFloat(match[1]);rest<0&&(grade+=rest)}return grade}function formatGrade(grade){return grade<0?0:Math.round(100*grade)/100}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.updateSubmissionsList=_exports.setupGetGradeCommentList=_exports.setup=_exports.highlightSubmission=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj};const setupGetGradeCommentList=id=>{(0,_jquery.default)("#vpl_load_grading_help").on("click",(function(){var panel=(0,_jquery.default)("#vpl_grading_help_panel");(0,_jquery.default)(this).remove();panel.removeClass("d-none"),panel.addClass("flex-grow-1"),panel.html(M.util.get_string("loading","moodle")+' <i class="icon fa fa-spinner fa-pulse fa-fw " aria-hidden="true"></i>'),_jquery.default.ajax({method:"GET",url:M.cfg.wwwroot+"/mod/vpl/forms/grading_help.php?id="+id,success:function(data){const textarea=(0,_jquery.default)("#id_comments");textarea.css("margin-right","1em"),textarea.css("resize","both"),panel.css("overflow-y","scroll"),data.success?panel.html(data.response):panel.html(data.error),window.VPL.resizeSView(),setInterval(window.VPL.resizeSView,5e3)},error:function(){panel.html(M.util.get_string("error","moodle"))}})}))};_exports.setupGetGradeCommentList=setupGetGradeCommentList;_exports.setup=id=>{(0,_jquery.default)('button[data-role="calculategrade"]').click((function(){var $form=(0,_jquery.default)(this).closest("form"),text=$form.find('[name="comments"]').val(),grade=parseFloat((0,_jquery.default)(this).data("maxgrade"));grade=formatGrade(reduceGradeWithComments(grade,text)),$form.find('[name="grade"]').val(grade)})),(0,_jquery.default)('button[data-role="mergegrade"]').click((function(){var $form=(0,_jquery.default)(this).closest("form"),gridpoints=0;$form.find(".score .scorevalue").length>0?$form.find(".checked .score .scorevalue").each((function(){gridpoints+=Number((0,_jquery.default)(this).text())})):$form.find(".score input").each((function(){gridpoints+=Number((0,_jquery.default)(this).val())}));var advancedgradingcomments="";$form.find(".criterion .remark textarea").each((function(){advancedgradingcomments+=(0,_jquery.default)(this).val()+"\n"})),gridpoints=reduceGradeWithComments(gridpoints,advancedgradingcomments);var maxgrade=(0,_jquery.default)(this).data("maxgrade"),currentgrade=(0,_jquery.default)(this).data("currentgrade"),grade=formatGrade(currentgrade-(0,_jquery.default)(this).data("maxgridpoints")*(currentgrade/maxgrade)+gridpoints);$form.find('[name="grade"]').val(grade);var $comments=$form.find('[name="comments"]'),text=$comments.val(),gridcomment="#Grid grade: "+grade,proposedcomment="#Proposed grade: "+currentgrade;text=(text=text.search("#Grid grade")<0?gridcomment+"\n"+text:text.replace(new RegExp("#Grid grade.*"),gridcomment)).search("#Proposed grade")<0?proposedcomment+"\n"+text:text.replace(new RegExp("#Proposed grade.*"),proposedcomment),$comments.val(text)})),(0,_jquery.default)('button[data-role="importfromsub"]').click((function(){var $form=(0,_jquery.default)(this).closest("form");$form.find('[name="grade"]').val((0,_jquery.default)(this).data("grade")),$form.find('[name="comments"]').val((0,_jquery.default)(this).data("comments")),(0,_jquery.default)("#advancedgrading-criteria .criterion .remark textarea").val(""),(0,_jquery.default)("#advancedgrading-criteria .criterion .score input").val(""),(0,_jquery.default)("#advancedgrading-criteria .criterion .level.checked").click(),(0,_jquery.default)(this).data("advgrading").forEach((function(criterion){var id=criterion.criterionid;void 0!==criterion.remark&&$form.find('[name="advancedgrading[criteria]['+id+'][remark]"]').val(criterion.remark),void 0!==criterion.score&&$form.find('[name="advancedgrading[criteria]['+id+'][score]"]').val(parseFloat(criterion.score)),void 0!==criterion.levelid&&(0,_jquery.default)("#advancedgrading-criteria-"+id+"-levels-"+criterion.levelid).click()}))})),setupGetGradeCommentList(id)};_exports.updateSubmissionsList=(submissionID,gradeData,nexturl)=>{if(null!==opener&&((0,_jquery.default)(opener.document).find("#g"+submissionID).html(gradeData.grade),(0,_jquery.default)(opener.document).find("#m"+submissionID).html(gradeData.grader),(0,_jquery.default)(opener.document).find("#o"+submissionID).html(gradeData.gradedon),(0,_jquery.default)(opener.document).find("#c"+submissionID).html(gradeData.comments),(0,_jquery.default)(opener.document).find(".gd"+submissionID).css("color","").css("backgroundColor","")),nexturl){null===opener&&window.close();var nextrow=(0,_jquery.default)(opener.document).find("#g"+submissionID).closest("tr").next();0==nextrow.length&&window.close();var nextid=nextrow.html().match(/user\/view\.php\?(.*?)id=([0-9]+)/)[2];nextid?location.replace(nexturl+nextid):window.close()}};_exports.highlightSubmission=submissionID=>{null!==opener&&((0,_jquery.default)(opener.document).find(".gd"+submissionID).css("color","black").css("backgroundColor","yellow"),window.addEventListener("pagehide",(function(){(0,_jquery.default)(opener.document).find(".gd"+submissionID).css("color","").css("backgroundColor","")})))},function(){"object"!=typeof window.VPL&&(window.VPL={}),window.VPL.addComment=function(comment){if(!comment)return;const field=document.getElementById("id_comments");if(!field)return;const cleanComment=comment.replace(/\(\s*-\s*\d(\.\d+)?\s*\)\s*$/,""),formattedComment="-"+comment+"\n",currentText=field.value,foundIndex=currentText.indexOf(cleanComment);if(-1!==foundIndex)return field.setSelectionRange(foundIndex,foundIndex+cleanComment.length),field.scrollTop=field.scrollHeight*(foundIndex/currentText.length),void field.focus();const endPos=field.selectionEnd;let textToInsert=formattedComment;const nextNewLine=currentText.indexOf("\n",endPos);let insertpos;-1===nextNewLine?(insertpos=currentText.length,insertpos>0&&"\n"!==currentText.charAt(insertpos-1)&&(textToInsert="\n"+textToInsert)):insertpos=nextNewLine+1,field.setRangeText(textToInsert,insertpos,insertpos,"select"),field.focus(),field.dispatchEvent(new Event("input",{bubbles:!0}))},window.VPL.resizeSView=function(){const commentsView=window.document.getElementById("vpl_grading_help_panel"),textarea=window.document.getElementById("id_comments");if(commentsView&&textarea){const parent=commentsView.parentElement,newHeight=textarea.offsetHeight;newHeight!=commentsHeight&&(commentsHeight=newHeight,commentsView.style.height=commentsHeight+"px");const newWidth=parent.clientWidth-textarea.offsetWidth-20;newWidth>200&&newWidth!=commentsWidth&&(commentsWidth=newWidth,commentsView.style.width=commentsWidth+"px")}};var commentsHeight=0,commentsWidth=0;window.addEventListener("resize",window.VPL.resizeSView)}()}));

//# sourceMappingURL=gradeform.min.js.map