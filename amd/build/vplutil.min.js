/**
 * Tools for the VPL IDE
 *
 * @copyright 2016 Juan Carlos Rodríguez-del-Pino
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>
 */
define("mod_vpl/vplutil",["jquery","jqueryui","core/log"],(function($,jqui,log){var VPLUtil={};VPLUtil.doNothing=$.noop,VPLUtil.returnFalse=function(){return!1},VPLUtil.returnTrue=function(){return!0};var fileUniqueId,MIME,maplang,i18n,strreg,menuIcons,lastProccessID,scriptsLoaded,debugMode=!1;return VPLUtil.log=function(m,forced){(debugMode||forced)&&log.debug(m)},VPLUtil.setUserPreferences=function(pref){$.ajax({async:!0,type:"POST",url:"../editor/userpreferences.json.php",data:JSON.stringify(pref),contentType:"application/json; charset=utf-8",dataType:"json"})},VPLUtil.getUserPreferences=function(func){$.ajax({async:!0,type:"POST",url:"../editor/userpreferences.json.php",data:JSON.stringify({getPreferences:!0}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(func)},VPLUtil.scrollBarWidth=function(){var parent,child,width;return width=(child=(parent=$('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo("body")).children()).innerWidth()-child.height(99).innerWidth(),parent.remove(),width},VPLUtil.sanitizeHTML=function(t){return void 0===t||""==t.replace(/^\s+$/g,"")?"":$("<div>"+t+"</div>").html()},VPLUtil.sanitizeText=function(s){return void 0===s||""==s.replace(/^\s+$/g,"")?"":s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},VPLUtil.setProtocol=function(coninfo){var secure;if(0==coninfo.securePort||0==coninfo.port)secure=0==coninfo.port;else switch(coninfo.wsProtocol){case"always_use_wss":secure=!0;break;case"always_use_ws":secure=!1;break;default:secure="https:"==window.location.protocol}var URLBase=(secure?"wss://":"ws://")+coninfo.server;coninfo.secure=secure,coninfo.portToUse=secure?coninfo.securePort:coninfo.port,URLBase+=":"+coninfo.portToUse+"/",coninfo.monitorURL=URLBase+coninfo.monitorPath,coninfo.executionURL=URLBase+coninfo.executionPath},VPLUtil.ArrayBuffer2String=function(data){var i,len,view=new Uint8Array(data),chunks=[];for(i=0,len=view.length;i<len;i+=32e3)chunks.push(String.fromCharCode.apply(String,view.subarray(i,Math.min(i+32e3,len))));return chunks.join("")},VPLUtil.String2ArrayBuffer=function(data){for(var len=data.length,ret=new ArrayBuffer(len),u8=new Uint8Array(ret),i=0;i<len;i++)u8[i]=data.charCodeAt(i);return ret},fileUniqueId=0,VPLUtil.getUniqueId=function(){return fileUniqueId++},function(){var regExt=/\.([^.]*)$/,regImg=/^(gif|jpg|jpeg|png|ico)$/i,regBin=/^(zip|jar|pdf|tar|bin|7z|arj|deb|gzip|rar|rpm|dat|db|dll|rtf|doc|docx|odt|exe|com)$/i,regBlk=/^blockly[0123]?$/;VPLUtil.fileExtension=function(fileName){var res=regExt.exec(fileName);return null!==res?res[1]:""},VPLUtil.isImage=function(fileName){return regImg.test(VPLUtil.fileExtension(fileName))},VPLUtil.isBinary=function(fileName){return VPLUtil.isImage(fileName)||regBin.test(VPLUtil.fileExtension(fileName))},VPLUtil.isBlockly=function(fileName){return regBlk.test(VPLUtil.fileExtension(fileName))};var regInvalidFileName=/[\cA-\cZ]|[:-@]|[{-~]|\\|\[|\]|[/^`´]|^-|^ | $|\.\./;VPLUtil.validFileName=function(fileName){return!(fileName.length<1)&&(!(fileName.length>128)&&!regInvalidFileName.test(fileName))}}(),VPLUtil.getCurrentTime=function(){return parseInt((new Date).valueOf()/1e3)},VPLUtil.encodeBinary=function(name,data){return VPLUtil.isBinary(name)?btoa(VPLUtil.ArrayBuffer2String(data)):btoa(unescape(encodeURIComponent(data)))},VPLUtil.decodeBinary=function(name,data){var decoded=atob(data);return VPLUtil.isBinary(name)?VPLUtil.String2ArrayBuffer(decoded):decodeURIComponent(escape(decoded))},VPLUtil.validPath=function(path){if(path.length>256)return!1;for(var dirs=path.split("/"),i=0;i<dirs.length;i++)if(!VPLUtil.validFileName(dirs[i]))return!1;return!0},VPLUtil.getFileName=function(path){var dirs=path.split("/");return dirs[dirs.length-1]},VPLUtil.dataFromURLData=function(data){return data.substr(data.indexOf(",")+1)},VPLUtil.readZipFile=function(data,save,progressBar,end){if(end||(end=VPLUtil.doNothing),"undefined"!=typeof JUnzip){var ab=VPLUtil.ArrayBuffer2String(data),unzipper=new JUnzip(ab);if(!unzipper.isZipFile())return VPLUtil.log("Not a ZIP file"),void end();unzipper.readEntries();var out=unzipper.entries.length;!function process(i){if(i>=out||progressBar.isClosed())end();else{var data,entry=unzipper.entries[i],fileName=entry.fileName;if(fileName.match(/\/$/))process(i+1);else{progressBar.processFile(fileName);var uncompressed="";if(0===entry.compressionMethod?uncompressed=entry.data:8===entry.compressionMethod&&(uncompressed=JSInflate.inflate(entry.data)),VPLUtil.isBinary(fileName))save({name:fileName,contents:btoa(uncompressed),encoding:1}),process(i+1);else{data=VPLUtil.String2ArrayBuffer(uncompressed);var blob=new Blob([data],{type:"text/plain"}),fr=new FileReader;fr.onload=function(e){save({name:fileName,contents:e.target.result,encoding:0}),process(i+1)},fr.onerror=function(e){VPLUtil.log(e),process((i=out)+1)},fr.readAsText(blob)}}}}(0)}else VPLUtil.loadScript(["../editor/zip/inflate.js","../editor/zip/unzip.js"],(function(){VPLUtil.readZipFile(data,save,progressBar,end)}))},VPLUtil.readSelectedFiles=function(filesToRead,save,end){var pb=new VPLUtil.progressBar("import","import"),errorsMessages="";end||(end=VPLUtil.doNothing),pb.processFile=function(name){pb.setLabel(name)},function readSecuencial(sec){if(sec>=filesToRead.length||pb.isClosed())return end(),pb.close(),void(errorsMessages>""&&VPLUtil.showErrorMessage(errorsMessages));var f=filesToRead[sec];pb.processFile(f.name);var binary=VPLUtil.isBinary(f.name),reader=new FileReader,ext=VPLUtil.fileExtension(f.name).toLowerCase();reader.onload=function(e){if(binary)if("zip"==ext)try{return void VPLUtil.readZipFile(e.target.result,save,pb,(function(){readSecuencial(sec+1)}))}catch(ex){VPLUtil.showErrorMessage(ex+" : "+f.name)}else{var data=VPLUtil.dataFromURLData(e.target.result);save({name:f.name,contents:data,encoding:1})}else save({name:f.name,contents:e.target.result,encoding:0});readSecuencial(sec+1)},reader.onerror=function(e){errorsMessages+='Error "'+e.target.error+'" reading '+f.name+"\n",readSecuencial(sec+1)},binary?"zip"==ext?reader.readAsArrayBuffer(f):reader.readAsDataURL(f):reader.readAsText(f)}(0)},MIME={gif:"image/gif",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",ico:"image/vnd.microsoft.icon",pdf:"application/pdf"},VPLUtil.getMIME=function(fileName){var ext=VPLUtil.fileExtension(fileName);return ext in MIME?MIME[ext]:"application/octet-stream"},VPLUtil.getTimeLeft=function(timeLeft){var res="";timeLeft<0&&(res+="-",timeLeft=-timeLeft);var timePending=timeLeft,days=parseInt(timePending/86400);timePending-=86400*days,0!==days&&(res+=days+"T");var hours=parseInt(timePending/3600);timePending-=3600*hours;var minutes=parseInt(timePending/60);timePending-=60*minutes;var seconds=parseInt(timePending);return res+=("00"+hours).substr(-2)+":",res+=("00"+minutes).substr(-2),timeLeft<3600&&(res+=":"+("00"+seconds).substr(-2)),res},maplang={abap:"abap",abc:"abc",ada:"ada",ads:"ada",adb:"ada",as:"actionscript",as3:"actionscript",asm:"assembly_x86",bash:"sh",bat:"batchfile",c:"c_cpp",C:"c_cpp",cc:"c_cpp",cpp:"c_cpp","c++":"c_cpp",hxx:"c_cpp",h:"c_cpp",H:"c_cpp",cases:"cases",cbl:"cobol",cob:"cobol",coffee:"coffee",clj:"clojure",cs:"csharp",css:"css",d:"d",dart:"dart",e:"eiffel",erl:"erlang",hrl:"erlang",f:"fortran",f77:"fortran",f90:"fortran",for:"fortran",go:"golang",groovy:"groovy",gv:"dot",hs:"haskell",htm:"html",html:"html",hx:"haxe",java:"java",jl:"julia",js:"javascript",json:"json",jsp:"jsp",jsx:"jsx",kt:"kotlin",kts:"kotlin",m:"matlab",md:"markdown",less:"less",lisp:"lisp",lsp:"lisp",lua:"lua",pas:"pascal",p:"pascal",perl:"perl",prl:"perl",php:"php",pro:"prolog",pl:"prolog",py:"python",R:"r",r:"r",rb:"ruby",ruby:"ruby",s:"assembly_x86",sass:"sass",scala:"scala",scm:"scheme",scss:"scss",sh:"sh",swift:"swift",sql:"sql",svg:"svg",tex:"tex",tcl:"tcl",ts:"typescript",twig:"twig",vbs:"vbscript",v:"verilog",vh:"verilog",vhd:"vhdl",vhdl:"vhdl",xml:"xml",yaml:"yaml"},VPLUtil.langType=function(ext){return ext in maplang?maplang[ext]:"plain_text"},i18n={},strreg=/\{\\*\$a\\*}/g,VPLUtil.str=function(key,parm){return i18n[key]?void 0!==parm?i18n[key].replace(strreg,parm):i18n[key]:"{"+key+"}"},VPLUtil.setStr=function(newi18n){for(var key in newi18n)newi18n.hasOwnProperty(key)&&(i18n[key]=newi18n[key]);VPLUtil.dialogbaseOptions={minWidth:200,autoOpen:!1,width:"auto",closeText:VPLUtil.str("cancel"),modal:!0,dialogClass:"vpl_ide vpl_ide_dialog"}},VPLUtil.setStr(window.VPLi18n),function(){var delayedActions={},afterAllActions={},numberDelayed=0,internalDelay=function(timeout,id,func,arg1,arg2){void 0!==delayedActions[id]&&(clearTimeout(delayedActions[id]),numberDelayed--),numberDelayed++,delayedActions[id]=setTimeout((function(){numberDelayed--,func(arg1,arg2),delete delayedActions[id]}),timeout)};VPLUtil.delay=function(id,func,arg1,arg2){internalDelay(20,id,func,arg1,arg2)},VPLUtil.longDelay=function(id,func,arg1,arg2){internalDelay(100,id,func,arg1,arg2)};var setAfterTimeout=function(id,func,arg1,arg2){void 0!==afterAllActions[id]&&clearTimeout(afterAllActions[id]),afterAllActions[id]=setTimeout((function(){numberDelayed>0?afterAllActions[id]=setAfterTimeout(id,func,arg1,arg2):(func(arg1,arg2),delete afterAllActions[id])}),100)};VPLUtil.afterAll=function(id,func,arg1,arg2){setAfterTimeout(id,func,arg1,arg2)}}(),VPLUtil.iconModified=function(){var html='<span title="'+VPLUtil.str("modified")+'" class="vpl_ide_charicon">';return html+='<i class="fa fa-star"></i></span> '},VPLUtil.iconDelete=function(){var html=' <span title="'+VPLUtil.str("delete")+'" class="vpl_ide_charicon vpl_ide_delicon">';return html+='<i class="fa fa-trash"></i></span> '},VPLUtil.iconClose=function(){var html=' <span title="'+VPLUtil.str("closebuttontitle");return html+='" class="vpl_ide_charicon vpl_ide_closeicon"><i class="fa fa-remove"></i></span> '},VPLUtil.iconRequired=function(){var html=' <span title="'+VPLUtil.str("required")+'" class="vpl_ide_charicon">';return html+='<i class="fa fa-shield"></i></span> '},VPLUtil.iconFolder=function(){return'<i class="fa fa-folder-open-o"></i>'},menuIcons={filelist:"folder-open-o",filelistclose:"folder-o",new:"file-code-o",rename:"pencil",delete:"trash",multidelete:"trash|list",close:"remove",comments:"commenting",import:"upload",print:"print",edit:"edit",undo:"undo",redo:"repeat",select_all:"location-arrow",find:"search",find_replace:"exchange",next:"search-plus",resetfiles:"refresh",download:"download",fullscreen:"expand",regularscreen:"compress",save:"save",shortcuts:"flash",sort:"list-ol",run:"rocket",running:"rocket fa-spin",debug:"bug",evaluate:"check-square-o",console:"terminal",about:"question",info:"info-circle",alert:"warning",trash:"trash",retrieve:"download",spinner:"refresh fa-spin",keyboard:"keyboard-o",clipboard:"clipboard",timeleft:"clock-o",copy:"copy",paste:"paste",more:"plus-square",less:"minus-square",resize:"arrows-alt",graphic:"picture-o",send:"send",theme:"paint-brush",user:"user",fontsize:"text-height","close-rightpanel":"caret-square-o-right","open-rightpanel":"caret-square-o-left"},VPLUtil.genIcon=function(icon,size){if(!menuIcons[icon])return"";var classes="fa fa-";classes+=size||"lg";for(var icons=menuIcons[icon].split("|"),ret="",i=0;i<icons.length;i++)ret+="<i class='"+classes+" fa-"+icons[i]+"'></i>";return ret},VPLUtil.setTitleBar=function(dialog,type,icon,buttons,handler){var title=$(dialog).parent().find("span.ui-dialog-title");function genButton(e){var html="<a id='vpl_"+type+"_"+e+"' href='#' title='"+VPLUtil.str(e)+"'>";return html+=VPLUtil.genIcon(e,"fw")+"</a>"}var html=VPLUtil.genIcon(icon);html+=" <span class='"+type+"-title-buttons'></span>",html+="<span class='"+type+"-title-text'></span>",title.html(html);var titleButtons=title.find("span."+type+"-title-buttons"),titleText=title.find("span."+type+"-title-text");html="";for(var i=0;i<buttons.length;i++)html+=genButton(buttons[i]);titleButtons.html(html);for(var ih=0;ih<handler.length;ih++){var button=title.find("#vpl_"+type+"_"+buttons[ih]);button.button().click(handler[ih]),button.css("padding","1px 3px")}return titleButtons.on("focus","*",(function(){$(this).blur()})),titleText},VPLUtil.setDialogTitleIcon=function(dialog,icon){var title=$(dialog).parent().find("span.ui-dialog-title");title.html(VPLUtil.genIcon(icon)+" "+title.html())},VPLUtil.progressBar=function(title,message,onUserClose){var sppiner='<div class="vpl_ide_progressbaricon">'+VPLUtil.genIcon("spinner")+"</div>",dialog=$('<div class="vpl_ide_dialog" style="display:none;">'+(' <div class="vpl_ide_progressbar">'+sppiner+'<span class="vpl_ide_progressbarlabel"></span></div>')+"</div>");$("body").append(dialog);var label=dialog.find(".vpl_ide_progressbar").find(".vpl_ide_progressbarlabel");dialog.dialog({title:VPLUtil.str(title),resizable:!1,autoOpen:!1,width:200,height:20,minHeight:20,modal:!0,dialogClass:"vpl_ide vpl_ide_dialog",close:function(event){dialog&&(onUserClose&&event.originalEvent&&onUserClose(),onUserClose=!1)}}),this.setLabel=function(t,icon){dialog&&(label.text(t),icon&&label.html(VPLUtil.genIcon(icon)+" "+label.html()))},this.close=function(){dialog&&(dialog.dialog("destroy"),$(dialog).remove(),dialog=!1)},this.isClosed=function(){return!1===dialog};var titleTag=dialog.siblings().find(".ui-dialog-title");titleTag.html(VPLUtil.genIcon(title)+" "+titleTag.html()),this.setLabel(VPLUtil.str(message)),dialog.dialog("open"),dialog.dialog("option","height","auto")},VPLUtil.showMessage=function(message,initialoptions){var options=$.extend({},VPLUtil.dialogbaseOptions,initialoptions),messageDialog=$('<div class="vpl_ide_dialog" style="display:none"></div>'),icon="",contents=' <span class="dmessage">'+message.replace(/\n/g,"<br>")+"</span>";messageDialog.html(contents),void 0===options.icon?icon="info":(icon=options.icon,delete options.icon),options.title||(options.title=VPLUtil.str("warning")),$("body").append(messageDialog);var messageButtons={};"function"==typeof initialoptions.ok?(messageButtons[VPLUtil.str("ok")]=function(){$(this).dialog("close"),initialoptions.ok()},messageButtons[VPLUtil.str("cancel")]=function(){$(this).dialog("close")},delete options.ok):"function"==typeof initialoptions.yes?(messageButtons[VPLUtil.str("yes")]=function(){$(this).dialog("close"),initialoptions.yes()},messageButtons[VPLUtil.str("no")]=function(){$(this).dialog("close")},delete options.yes):messageButtons[VPLUtil.str("close")]=function(){$(this).dialog("close")},options.next&&(messageButtons[VPLUtil.str("next")]=function(){$(this).dialog("close"),initialoptions.next()}),options.close=function(){$(this).remove(),initialoptions.close&&initialoptions.close()},options.buttons=messageButtons,messageDialog.dialog(options);var titleTag=messageDialog.siblings().find(".ui-dialog-title");return titleTag.html(VPLUtil.genIcon(icon)+" "+titleTag.html()),messageDialog.setMessage=function(men){$(messageDialog).find(".dmessage").html(men.replace(/\n/g,"<br>"))},messageDialog.dialog("open"),messageDialog},VPLUtil.showErrorMessage=function(message,options){var currentOptions=$.extend({},VPLUtil.dialogbaseOptions,{title:VPLUtil.str("error"),icon:"alert"});return options&&(currentOptions=$.extend(currentOptions,options)),VPLUtil.showMessage(message,currentOptions)},VPLUtil.requestAction=function(action,title,data,URL,noDialog){var deferred=$.Deferred(),request=null,xhr=!1,apb=!1;return noDialog||(""===title&&(title="connecting"),apb=new VPLUtil.progressBar(action,title,(function(){4!=request.readyState&&xhr&&xhr.abort&&xhr.abort()}))),request=$.ajax({beforeSend:function(jqXHR){return xhr=jqXHR,!0},async:!0,type:"POST",url:URL+action,data:JSON.stringify(data),contentType:"application/json; charset=utf-8",dataType:"json"}).always((function(){noDialog||apb.close()})).done((function(response){response.success?deferred.resolve(response.response):deferred.reject(response.error)})).fail((function(jqXHR,textStatus,errorThrown){var message=VPLUtil.str("connection_fail")+": "+textStatus;debugMode&&null!=errorThrown.message&&(message+=": "+errorThrown.message),VPLUtil.log(message),deferred.reject(message)})),deferred},VPLUtil.supportWebSocket=function(){return"WebSocket"in window},VPLUtil.isAndroid=function(){return window.navigator.userAgent.indexOf("Android")>-1},VPLUtil.isFirefox=function(){return window.navigator.userAgent.indexOf("Firefox")>-1},VPLUtil.isMac=function(){return window.navigator.userAgent.indexOf("Mac")>-1},VPLUtil.clickServer=function(e){var left=screen.width/2-275,top=screen.height/2-225;try{var features="toolbar=no, location=no, directories=no, status=no, menubar=no";if(features+=", resizable=yes, scrollbars=yes, copyhistory=no, width=550",features+=", height=450, top="+top+", left="+left,!window.open($(this).attr("href"),"_blank",features))return!0}catch(ex){return VPLUtil.log(ex),!0}return e.preventDefault(),$(this).parent().hide(),!1},VPLUtil.acceptCertificates=function(servers,getLastAction){if(servers.length>0){var i,html=VPLUtil.str("acceptcertificatesnote");for(i in html+="<ol>",servers)if(servers.hasOwnProperty(i)){var n=1+i;html+='<li><a href="'+servers[i]+'" target="_blank">Server ',html+=n+"</a></li>"}html+="</ol>";var m=VPLUtil.showMessage(html,{ok:function(){var action=getLastAction();action&&action()},icon:"unlocked",title:VPLUtil.str("acceptcertificates")});$(m).find("a").on("click keypress",VPLUtil.clickServer)}else VPLUtil.log("servers.length == 0"),VPLUtil.showErrorMessage(VPLUtil.str("connection_fail"))},VPLUtil.monitorRunning=VPLUtil.returnFalse,lastProccessID=-1,VPLUtil.setProcessId=function(id){lastProccessID=id},VPLUtil.getProcessId=function(){return lastProccessID},VPLUtil.webSocketMonitor=function(coninfo,title,running,externalActions){VPLUtil.setProtocol(coninfo),VPLUtil.setProcessId(coninfo.processid);var ws=null,pb=null,deferred=$.Deferred(),defail=function(m){deferred.reject(m)},delegated=!1,messageActions={message:function(content){var parsed=/^([^:]*):?([^]*)/.exec(content),state=parsed[1],detail=parsed[2];"running"==state&&(state=running);var text=VPLUtil.str(state);detail>""&&(text+=": "+detail),null===pb||pb.isClosed()?externalActions.getConsole&&externalActions.getConsole().isOpen()?externalActions.getConsole().setMessage(text):VPLUtil.log("Error: no dialogo. Message not shown: "+text):pb.setLabel(text)},compilation:function(content){externalActions.setResult&&externalActions.setResult({compilation:content},!1)},retrieve:function(){var data={processid:VPLUtil.getProcessId()};pb.close(),delegated=!0,VPLUtil.requestAction("retrieve","",data,externalActions.ajaxurl).done((function(response){deferred.resolve(),externalActions.setResult&&externalActions.setResult(response,!0)})).fail(defail)},run:function(content){pb.close(),externalActions.run(content,coninfo,ws)},close:function(){VPLUtil.log("ws close message from jail"),ws.close();var data={processid:VPLUtil.getProcessId()};VPLUtil.requestAction("cancel","",data,externalActions.ajaxurl,!0)}};try{if(!VPLUtil.supportWebSocket())return VPLUtil.log("ws not available"),deferred.reject(VPLUtil.str("browserupdate")),deferred;ws=new WebSocket(coninfo.monitorURL)}catch(e){return VPLUtil.log("ws new say "+e),deferred.reject(e.message),deferred}return pb=new VPLUtil.progressBar(title,"connecting",(function(){deferred.reject("Stopped by user"),ws.close()})),ws.notOpen=!0,ws.onopen=function(){ws.notOpen=!1,pb.setLabel(VPLUtil.str("connected")),externalActions.open&&externalActions.open()},ws.onerror=function(event){VPLUtil.log("ws error "+event),pb.close(),coninfo.secure&&ws.notOpen?VPLUtil.requestAction("getjails","retrieve",{},externalActions.ajaxurl).done((function(response){VPLUtil.acceptCertificates(response.servers,(function(){return externalActions.getLastAction()}))})).fail(defail):deferred.reject(VPLUtil.str("connection_fail")),externalActions.close&&VPLUtil.delay("externalActions.close",externalActions.close)},ws.onclose=function(){externalActions.getConsole&&externalActions.getConsole().disconnect(),ws.notOpen||(pb.close(),delegated||"rejected"==deferred.state()||deferred.resolve()),externalActions.close&&externalActions.close()},ws.onmessage=function(event){var message=/^([^:]+):([^]*)/.exec(event.data);if(null!==message){var action=message[1],content=message[2];messageActions[action]&&messageActions[action](content)}else pb.setLabel(VPLUtil.str("error")+": "+event.data)},VPLUtil.monitorRunning=function(){return null!==ws&&ws.readyState!=WebSocket.CLOSED},deferred},VPLUtil.directRun=function(URL,command,files){var deferred=$.Deferred();return $.ajax({async:!0,type:"POST",url:URL+"directrun",data:JSON.stringify({command:command,files:files}),contentType:"application/json; charset=utf-8",dataType:"json"}).done((function(result){if(result.success){var response=result.response;VPLUtil.setProtocol(response);var ws=new WebSocket(response.executionURL);log.debug("Conecting with:"+response.executionURL),deferred.resolve({processid:response.processid,homepath:response.homepath,connection:ws})}else deferred.reject(result.error)})).fail((function(jqXHR,textStatus,errorThrown){var message="Connection fail: "+textStatus;null!=errorThrown.message&&(message+=": "+errorThrown.message),log.debug(message),deferred.reject(message)})),deferred},VPLUtil.directRunTest=function(URL,command,data){VPLUtil.directRun(URL,command,[{name:"a.c",contents:"int main(){return 0;}",encoding:0},{name:"b.c",contents:"int f(){return 1;}",encoding:0}]).done((function(result){var mcount=0;result.connection.onopen=function(){log.debug("Ws open "+result.homepath+" processid "+result.processid),null!=data&&result.connection.send(data),setTimeout((function(){result.connection.close()}),6e5)},result.connection.onmessage=function(event){log.debug("WS Message ("+ ++mcount+"): "+event.data),mcount>=10&&result.connection.close()},result.connection.onerror=function(event){log.debug("WS error: "+event)},result.connection.onclose=function(event){log.debug("WS close: "+event.code+" "+event.reason)}})).fail((function(message){log.debug("Direct run fail. URL: "+URL+" command: "+command+" message: "+message)}))},VPLUtil.processResult=function(text,filenames,sh,noFormat,folding){if(void 0===text||""==text.replace(/^\s+$/gm,""))return"";function escReg(t){return t.replace(/[-[\]{}()*+?.,\\^$|#\s]/,"\\$&")}var regtitgra=/\([-]?[\d]+[.]?[\d]*\)\s*$/,regtit=/^-.*/,regcas=/^\s*>/,regError=new RegExp("\\[err\\]|error|"+escReg(VPLUtil.str("error")),"i"),regWarning=new RegExp("\\[warn\\]|warning|note|"+escReg(VPLUtil.str("warning")),"i"),regInformation=new RegExp("\\[info\\]|information","i"),state="",html="",comment="",case_="",lines=text.split(/\r\n|\n|\r/),regFiles=[],lastAnotation=!1,lastAnotationFile=!1,afterTitle=!1;function getHref(i){return void 0===sh[i].getTagId?'href="#" ':'href="#'+sh[i].getTagId()+'" '}function genFileLinks(line,rawline){for(var used=!1,i=0;i<regFiles.length;i++)for(var match,reg=regFiles[i];null!==(match=reg.exec(line));){var type,anot=sh[i].getAnnotations();lastAnotationFile=i,used=!0,type=line.search(regError)>-1?"error":line.search(regWarning)>-1?"warning":line.search(regInformation)>-1?"info":"error",lastAnotation={row:match[3]-1,column:match[5],type:type,text:rawline},anot.push(lastAnotation);var fileName=filenames[i],href=getHref(i),lt=VPLUtil.sanitizeText(fileName),data='data-file="'+fileName+'" data-line="'+match[3]+'"';line=line.replace(reg,"$1<a "+href+' class="vpl_fl" '+data+">"+lt+"$2$3$4$5$6</a>"),sh[i].setAnnotations(anot)}return!used&&lastAnotation&&(""!==rawline?(lastAnotation.text+="\n"+rawline,sh[lastAnotationFile].setAnnotations(sh[lastAnotationFile].getAnnotations())):lastAnotation=!1),line}function getTitle(line){lastAnotation=!1,line=line.substr(1);var end=regtitgra.exec(line);null!==end&&(line=line.substr(0,line.length-end[0].length));var html="";return folding&&(html+='<a href="javascript:void(0)" onclick="VPLUtil.showHideDiv(this)">[+]</a>'),html=genFileLinks(html+='<b class="ui-widget-header ui-corner-all">'+VPLUtil.sanitizeText(line)+"</b><br>",line)}function getComment(){lastAnotation=!1;var ret=comment;return comment="",ret}function addComment(rawline){var line=VPLUtil.sanitizeText(rawline);comment+=genFileLinks(line,rawline)+"<br>"}function addCase(rawline){var line=VPLUtil.sanitizeText(rawline);case_+=genFileLinks(line,rawline)+"\n"}function getCase(){lastAnotation=!1;var ret=case_;return case_="","<pre><i>"+ret+"</i></pre>"}!function(){for(var i=0;i<filenames.length;i++){var reg="(^| |/)"+escReg(filenames[i])+"( on line | line |:|\\()(\\d+)(:|,)?(\\d+)?(\\))?";regFiles[i]=new RegExp(reg,"m")}}();for(var i=0;i<lines.length;i++){var line=lines[i];if(noFormat)html+=genFileLinks(VPLUtil.sanitizeText(line),line)+"\n";else{var match=regcas.exec(line),regcasv=regcas.test(line);if(null!==match!=regcasv&&VPLUtil.log("error"),regtit.test(line)){switch(state){case"comment":html+=getComment();break;case"case":html+=getCase()}afterTitle&&(html+="</div>"),html+=getTitle(line),html+=folding?'<div style="display:none">':"<div>",afterTitle=!0,state=""}else regcasv?("comment"==state&&(html+=getComment()),addCase(line.substr(match[0].length)),state="case"):("case"==state&&(html+=getCase()),addComment(line),state="comment")}}switch(state){case"comment":html+=getComment();break;case"case":html+=getCase()}return afterTitle&&(html+="</div>"),html},scriptsLoaded=[],VPLUtil.loadScript=function(scripts,end){if(0!=scripts.length){var scriptURL=scripts[0];if(void 0===scriptsLoaded[scriptURL]){scripts.shift(),scriptsLoaded[scriptURL]=1;var script=document.createElement("script");script.type="text/javascript",script.src=VPLUtil.options.scriptPath+scriptURL,script.onload=function(){scriptsLoaded[scriptURL]=2,VPLUtil.loadScript(scripts,end)},document.head.appendChild(script)}else 2==scriptsLoaded[scriptURL]?(scripts.shift(),VPLUtil.loadScript(scripts,end)):(VPLUtil.log("Error loading js "+scriptURL+" "+scriptsLoaded[scriptURL]),setTimeout((function(){VPLUtil.loadScript(scripts,end)}),50))}else end()},VPLUtil.isScriptLoading=function(scriptURL){return void 0!==scriptsLoaded[scriptURL]&&1==scriptsLoaded[scriptURL]},VPLUtil.isScriptLoaded=function(scriptURL){return void 0!==scriptsLoaded[scriptURL]&&2==scriptsLoaded[scriptURL]},VPLUtil.adjustBlockly=function(work,offx,offy){for(var blocks=work.getAllBlocks(),miy=2e4,may=-2e4,mix=2e4,max=-2e4,i=0;i<blocks.length;i++){var xy=blocks[i].getRelativeToSurfaceXY();miy=Math.min(miy,xy.y),may=Math.max(may,xy.y),mix=Math.min(mix,xy.x),max=Math.max(max,xy.x)}blocks=work.getTopBlocks();for(var j=0;j<blocks.length;j++)blocks[j].moveBy(offx-mix,offy-miy);return may-miy+100+offy},function(){var files=[],results=[],shs=[],nFileGroupHighlighter=0;function FileGroupHighlighter(files,results){this.files=files.slice(),this.results=results.slice(),files=[],results=[],this.shFiles=[],this.shFileNames=[],nFileGroupHighlighter++,this.highlight()}FileGroupHighlighter.prototype.highlightBlockly=function(preid){VPLUtil.loadScript(["../editor/blockly/blockly_compressed.js","../editor/blockly/msg/js/en.js","../editor/blockly/blocks_compressed.js"],(function(){var tag=$("#"+preid),c=tag.html();$("#"+preid+"load").remove(),tag.html(""),tag.show(),c=$("<div />").html(c).text().replace(/\n/g,"");var xml=Blockly.Xml.textToDom(c);tag.html("").height(300).width(tag.parent().width());var work=Blockly.inject(preid,{toolbox:"",readOnly:!0,media:"../editor/blockly/media/"});Blockly.Xml.domToWorkspace(xml,work);var hg=VPLUtil.adjustBlockly(work,10,10);tag.height(hg),tag.width("100%"),Blockly.svgResize(work),Blockly.resizeSvgContents(work);var h=tag.html();work.dispose(),tag.html(h)}))},FileGroupHighlighter.prototype.highlight=function(){var self=this,needAce=!1,files=this.files;for(let i=0;i<files.length;i++){let file=files[i];if(!VPLUtil.isBinary(file.fileName)&&!VPLUtil.isBlockly(file.fileName)){needAce=!0;break}}needAce&&"undefined"==typeof ace?VPLUtil.loadScript(["../editor/ace9/ace.js"],(function(){self.highlight()})):VPLUtil.delay("FFGH."+nFileGroupHighlighter,(function(){self.highlightStep(0)}))},FileGroupHighlighter.prototype.highlightStep=function(pos){if(pos>=this.files.length)return void this.resultStep(0);let file=this.files[pos],preid="code"+file.tagId;if(VPLUtil.isBlockly(file.fileName))this.highlightBlockly(preid);else{var ext=VPLUtil.fileExtension(file.fileName),lang=VPLUtil.langType(ext);$("#"+preid).show(),$("#"+preid+"load").remove();var sh=ace.edit(preid);sh.setTheme("ace/theme/"+file.theme),sh.getSession().setMode("ace/mode/"+lang),sh.renderer.setShowGutter(file.showln),sh.setReadOnly(!0),sh.setHighlightActiveLine(!1),sh.setAutoScrollEditorIntoView(!0),sh.setOption("maxLines",file.nl),sh.getAnnotations=function(){return this.getSession().getAnnotations()},sh.setAnnotations=function(a){return this.getSession().setAnnotations(a)},sh.getTagId=function(){return this.vplTagId},sh.vplTagId=file.tagId,this.shFiles.push(sh),this.shFileNames.push(file.fileName),shs[file.tagId]=sh}var self=this;VPLUtil.delay(preid+".next",(function(){self.highlightStep(pos+1)}))},FileGroupHighlighter.prototype.resultStep=function(pos){if(!(pos>=this.results.length)){var self=this,result=this.results[pos],tag=document.getElementById(result.tagId),text=tag.textContent||tag.innerText;tag.innerHTML=VPLUtil.processResult(text,this.shFileNames,this.shFiles,result.noFormat,result.folding),VPLUtil.delay(tag+".next",(function(){self.resultStep(pos+1)}))}},VPLUtil.addResults=function(tagId,noFormat,folding){results.push({tagId:tagId,noFormat:noFormat,folding:folding})},VPLUtil.syntaxHighlightFile=function(tagId,fileName,theme,showln,nl){files.push({tagId:tagId,fileName:fileName,theme:theme,showln:showln,nl:nl})},VPLUtil.syntaxHighlight=function(){new FileGroupHighlighter(files,results)},VPLUtil.flEventHandler=function(event){var tag=event.target.getAttribute("href").substring(1),line=event.target.getAttribute("data-line"),sh=shs[tag];sh.gotoLine(line,0),sh.scrollToLine(line,!0)},VPLUtil.setflEventHandler=function(){for(var links=document.getElementsByClassName("vpl_fl"),i=0;i<links.length;i++)links[i].onclick=VPLUtil.flEventHandler},VPLUtil.showHideDiv=function(a){var text=a,div=a;for(div.nextSibling||(div=div.parentNode),div=div.nextSibling;"DIV"!=div.nodeName&&"PRE"!=div.nodeName;)if(!(div=div.nextSibling))return;text&&("[+]"==text.innerHTML?(div.savedDisplay?div.style.display=div.savedDisplay:div.style.display="",text.innerHTML="[-]"):(div.savedDisplay=div.style.display,div.style.display="none",text.innerHTML="[+]"))}}(),VPLUtil.options={scriptPath:""},void 0!==window.VPLDebugMode&&(debugMode=window.VPLDebugMode),VPLUtil.init=function(options){VPLUtil.options={scriptPath:""},$.extend(VPLUtil.options,options),void 0!==window.VPLDebugMode&&(debugMode=window.VPLDebugMode),VPLUtil.log(VPLUtil.options)},window.VPLUtil=VPLUtil,VPLUtil}));

//# sourceMappingURL=vplutil.min.js.map